<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片标注工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow: hidden;
        }

        .right-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 40px);
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .main-image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .required {
            color: #e74c3c;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conditional-section {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .reference-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .reference-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .reference-upload {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .reference-upload:hover {
            border-color: #007bff;
        }

        .uploaded-count {
            color: #007bff;
            font-weight: bold;
            margin-top: 5px;
        }

        .tag-wall {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-item {
            padding: 6px 12px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag-item:hover {
            background: #dee2e6;
        }

        .tag-item.selected {
            background: #007bff;
            color: white;
        }

        .add-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-button:hover {
            background: #218838;
        }

        .submit-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 30px;
        }

        .submit-button:hover {
            background: #0056b3;
        }

        .submit-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #ddd;
        }

        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #856404;
        }

        .section-title {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }

        .outfit-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .remove-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 左侧面板 -->
        <div class="left-panel">
            <h2>图片上传</h2>
            <div class="upload-area" id="mainUploadArea">
                <div>
                    <p>拖拽图片到这里或点击上传</p>
                    <p style="color: #666; font-size: 12px;">支持格式：PNG, JPG<br>分辨率：至少1920×1080，推荐2560×1440</p>
                </div>
                <input type="file" id="mainImageInput" accept="image/png,image/jpeg" style="display: none;">
            </div>
            <div id="mainImagePreview"></div>
            
            <h3 style="margin-top: 20px;">已上传图片预览</h3>
            <div id="allImagesPreview" class="image-preview-grid"></div>
        </div>

        <!-- 右侧面板 -->
        <div class="right-panel">
            <h2>标注信息</h2>
            <form id="annotationForm">
                <!-- 图片主题 -->
                <div class="form-group">
                    <label for="theme">图片所属主题 (选填)</label>
                    <select class="form-control" id="theme" name="theme">
                        <option value="">请选择主题</option>
                        <option value="fashion">时尚</option>
                        <option value="lifestyle">生活方式</option>
                        <option value="product">产品</option>
                        <option value="portrait">人像</option>
                    </select>
                </div>

                <!-- 图片类型 -->
                <div class="form-group">
                    <label>图片类型 <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="generated" name="reference_type" value="1" required>
                            <label for="generated">生成图</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="matching" name="reference_type" value="2" required>
                            <label for="matching">匹配图</label>
                        </div>
                    </div>
                </div>

                <!-- 生成图条件区域 -->
                <div id="generatedSection" class="conditional-section">
                    <h3 class="section-title">生成图信息</h3>
                    
                    <div class="form-group">
                        <label for="contentPrompt">生成时所用的提示词 <span class="required">*</span></label>
                        <textarea class="form-control" id="contentPrompt" name="content_prompt" rows="3" placeholder="请输入生成图片时使用的提示词"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="mlModel">使用模型 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="mlModel" name="ml_model_source" placeholder="请输入模型名称或URL">
                    </div>

                    <div class="reference-upload-grid">
                        <!-- 姿态参考 -->
                        <div class="reference-item">
                            <h4>姿态参考</h4>
                            <div class="reference-upload" data-type="pose">
                                <p>上传姿态参考图</p>
                                <div class="uploaded-count" id="poseCount">已上传: 0张</div>
                            </div>
                            <div id="poseDescriptions"></div>
                        </div>

                        <!-- 商品参考 -->
                        <div class="reference-item">
                            <h4>商品参考</h4>
                            <div class="reference-upload" data-type="outfit">
                                <p>上传商品参考图</p>
                                <div class="uploaded-count" id="outfitCount">已上传: 0张</div>
                            </div>
                            <div id="outfitDescriptions"></div>
                        </div>

                        <!-- 场景参考 -->
                        <div class="reference-item">
                            <h4>场景参考</h4>
                            <div class="reference-upload" data-type="scene">
                                <p>上传场景参考图</p>
                                <div class="uploaded-count" id="sceneCount">已上传: 0张</div>
                            </div>
                            <div id="sceneDescriptions"></div>
                        </div>

                        <!-- 构图参考 -->
                        <div class="reference-item">
                            <h4>构图参考</h4>
                            <div class="reference-upload" data-type="composition">
                                <p>上传构图参考图</p>
                                <div class="uploaded-count" id="compositionCount">已上传: 0张</div>
                            </div>
                            <div id="compositionDescriptions"></div>
                        </div>

                        <!-- 风格参考 -->
                        <div class="reference-item">
                            <h4>风格参考</h4>
                            <div class="reference-upload" data-type="style">
                                <p>上传风格参考图</p>
                                <div class="uploaded-count" id="styleCount">已上传: 0张</div>
                            </div>
                            <div id="styleDescriptions"></div>
                        </div>
                    </div>
                </div>

                <!-- 匹配图条件区域 -->
                <div id="matchingSection" class="conditional-section">
                    <h3 class="section-title">匹配图信息</h3>
                    
                    <div class="form-group">
                        <label for="productIds">商品ID (非必填)</label>
                        <input type="text" class="form-control" id="productIds" name="product_item_ids" placeholder="请输入商品ID">
                    </div>

                    <div class="form-group">
                        <label for="poseDescription">姿势描述 (选填)</label>
                        <textarea class="form-control" id="poseDescription" name="pose_description" rows="3" placeholder="请描述图片中人物的姿势"></textarea>
                    </div>

                    <div class="form-group">
                        <label>是否可被用于换脸 <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="faceYes" name="can_be_used_for_face_switching" value="true">
                                <label for="faceYes">是</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="faceNo" name="can_be_used_for_face_switching" value="false">
                                <label for="faceNo">否</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 风格标签 -->
                <div class="form-group">
                    <label>风格标签 <span class="required">*</span></label>
                    <div class="note">注意，这个style不是衣服的style，而是整个图的style</div>
                    <div id="styleTagsContainer">
                        <div class="tag-selection" id="styleTag0">
                            <select class="form-control" name="style_level1" style="margin-bottom: 10px;">
                                <option value="">选择一级风格</option>
                                <option value="realistic">写实</option>
                                <option value="artistic">艺术</option>
                                <option value="cartoon">卡通</option>
                            </select>
                            <select class="form-control" name="style_level2" style="margin-bottom: 10px;" disabled>
                                <option value="">选择二级风格</option>
                            </select>
                            <div class="tag-wall" id="styleTagWall0"></div>
                        </div>
                    </div>
                    <button type="button" class="add-button" onclick="addStyleTag()">+ 添加风格标签</button>
                </div>

                <!-- 场合标签 -->
                <div class="form-group">
                    <label>场合标签 <span class="required">*</span></label>
                    <div id="sceneTagsContainer">
                        <div class="tag-selection" id="sceneTag0">
                            <select class="form-control" name="scene_level1" style="margin-bottom: 10px;">
                                <option value="">选择一级场合</option>
                                <option value="daily">日常</option>
                                <option value="work">工作</option>
                                <option value="party">聚会</option>
                                <option value="outdoor">户外</option>
                            </select>
                            <select class="form-control" name="scene_level2" style="margin-bottom: 10px;" disabled>
                                <option value="">选择二级场合</option>
                            </select>
                            <div class="tag-wall" id="sceneTagWall0"></div>
                        </div>
                    </div>
                    <button type="button" class="add-button" onclick="addSceneTag()">+ 添加场合标签</button>
                </div>

                <!-- 模特数据标签 -->
                <div class="form-group">
                    <label>模特数据标签 <span class="required">*</span></label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px;">
                        <div>
                            <label>年龄</label>
                            <select class="form-control" name="age" required>
                                <option value="">选择年龄</option>
                                <option value="teen">青少年</option>
                                <option value="young">青年</option>
                                <option value="middle">中年</option>
                                <option value="senior">老年</option>
                            </select>
                        </div>
                        <div>
                            <label>性别</label>
                            <select class="form-control" name="gender" required>
                                <option value="">选择性别</option>
                                <option value="male">男性</option>
                                <option value="female">女性</option>
                            </select>
                        </div>
                        <div>
                            <label>种族</label>
                            <select class="form-control" name="race" required>
                                <option value="">选择种族</option>
                                <option value="asian">亚洲人</option>
                                <option value="caucasian">白人</option>
                                <option value="african">非洲人</option>
                                <option value="hispanic">拉丁裔</option>
                            </select>
                        </div>
                        <div>
                            <label>体型</label>
                            <select class="form-control" name="size" required>
                                <option value="">选择体型</option>
                                <option value="slim">苗条</option>
                                <option value="normal">标准</option>
                                <option value="plus">丰满</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 姿态标签 -->
                <div class="form-group">
                    <label for="poseTag">姿态标签 (选填)</label>
                    <select class="form-control" id="poseTag" name="pose_tag_ids">
                        <option value="">选择姿态</option>
                        <option value="standing_straight">站立-直立</option>
                        <option value="standing_lean">站立-倚靠</option>
                        <option value="standing_casual">站立-休闲</option>
                        <option value="sitting_chair">坐着-椅子</option>
                        <option value="sitting_floor">坐着-地面</option>
                        <option value="sitting_crossed">坐着-盘腿</option>
                        <option value="walking_forward">行走-向前</option>
                        <option value="walking_side">行走-侧向</option>
                        <option value="running">跑步</option>
                        <option value="jumping">跳跃</option>
                        <option value="dancing_ballet">舞蹈-芭蕾</option>
                        <option value="dancing_modern">舞蹈-现代</option>
                        <option value="dancing_street">舞蹈-街舞</option>
                        <option value="lying_down">躺着</option>
                        <option value="crouching">蹲着</option>
                        <option value="kneeling">跪着</option>
                        <option value="stretching">伸展</option>
                        <option value="yoga_pose">瑜伽姿势</option>
                        <option value="exercise">运动姿势</option>
                        <option value="thinking">思考姿势</option>
                        <option value="pointing">指向姿势</option>
                        <option value="waving">挥手</option>
                        <option value="embracing">拥抱</option>
                        <option value="holding_object">持物</option>
                    </select>
                </div>

                <!-- 构图标注 -->
                <div class="form-group">
                    <label>构图标注 (选填)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div>
                            <label>镜头类型</label>
                            <select class="form-control" name="camera_type">
                                <option value="">选择镜头类型</option>
                                <option value="extreme_close_up">极特写</option>
                                <option value="close_up">特写</option>
                                <option value="medium_close_up">中特写</option>
                                <option value="medium_shot">中景</option>
                                <option value="medium_long_shot">中远景</option>
                                <option value="long_shot">远景</option>
                                <option value="extreme_long_shot">极远景</option>
                                <option value="bird_eye_view">鸟瞰图</option>
                                <option value="worm_eye_view">虫眼视角</option>
                            </select>
                        </div>
                        <div>
                            <label>人身比例</label>
                            <select class="form-control" name="body_ratio">
                                <option value="">选择人身比例</option>
                                <option value="head_shot">头部特写</option>
                                <option value="head_shoulders">头肩比例</option>
                                <option value="bust_shot">半身像</option>
                                <option value="three_quarter">四分之三身</option>
                                <option value="full_body">全身像</option>
                                <option value="multiple_people">多人构图</option>
                            </select>
                        </div>
                        <div>
                            <label>人物位置</label>
                            <select class="form-control" name="character_position">
                                <option value="">选择人物位置</option>
                                <option value="center">居中</option>
                                <option value="left">左侧</option>
                                <option value="right">右侧</option>
                                <option value="upper_left">左上</option>
                                <option value="upper_center">上中</option>
                                <option value="upper_right">右上</option>
                                <option value="lower_left">左下</option>
                                <option value="lower_center">下中</option>
                                <option value="lower_right">右下</option>
                                <option value="off_center">偏心构图</option>
                                <option value="diagonal">对角线构图</option>
                                <option value="triangular">三角构图</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 服装标注 -->
                <div class="form-group">
                    <label>服装标注 <span class="required">*</span></label>
                    <div id="outfitDetailsContainer">
                        <div class="outfit-item" id="outfit0">
                            <button type="button" class="remove-button" onclick="removeOutfit(0)" style="display: none;">删除</button>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>服饰类别 <span class="required">*</span></label>
                                    <select class="form-control outfit-type" name="outfit_type_level1" required>
                                        <option value="">选择一级类别</option>
                                        <option value="top">上装</option>
                                        <option value="bottom">下装</option>
                                        <option value="dress">连衣裙</option>
                                        <option value="outerwear">外套</option>
                                    </select>
                                    <select class="form-control" name="outfit_type_level2" style="margin-top: 10px;" disabled>
                                        <option value="">选择二级类别</option>
                                    </select>
                                    <select class="form-control" name="outfit_type_level3" style="margin-top: 10px;" disabled>
                                        <option value="">选择三级类别</option>
                                    </select>
                                </div>
                                <div>
                                    <label>服饰材质 (选择最主要的一项)</label>
                                    <select class="form-control" name="fabric_tag_ids">
                                        <option value="">选择材质</option>
                                        <option value="cotton">棉</option>
                                        <option value="silk">丝绸</option>
                                        <option value="wool">羊毛</option>
                                        <option value="polyester">涤纶</option>
                                        <option value="denim">牛仔布</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <label>服饰版型</label>
                                    <select class="form-control" name="fit_tag_ids">
                                        <option value="">选择版型</option>
                                        <option value="slim">修身</option>
                                        <option value="regular">标准</option>
                                        <option value="loose">宽松</option>
                                        <option value="oversized">超宽松</option>
                                    </select>
                                </div>
                                <div>
                                    <label>颜色标签</label>
                                    <select class="form-control" name="color_tag_ids">
                                        <option value="">选择颜色</option>
                                        <option value="black">黑色</option>
                                        <option value="white">白色</option>
                                        <option value="red">红色</option>
                                        <option value="blue">蓝色</option>
                                        <option value="green">绿色</option>
                                        <option value="yellow">黄色</option>
                                        <option value="pink">粉色</option>
                                        <option value="gray">灰色</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="add-button" onclick="addOutfitDetail()">+ 添加服装标注</button>
                </div>

                <button type="submit" class="submit-button" id="submitButton" disabled>提交标注</button>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let mainImage = null;
        let referenceImages = {
            pose: [],
            outfit: [],
            scene: [],
            composition: [],
            style: []
        };
        let outfitCounter = 1;
        let styleTagCounter = 1;
        let sceneTagCounter = 1;

        // 模拟标签数据
        const mockTagData = {
            style: {
                realistic: {
                    portrait: ['商务照', '生活照', '艺术照', '证件照'],
                    fashion: ['时尚大片', '街拍', '杂志风', '复古风']
                },
                artistic: {
                    painting: ['油画风', '水彩风', '素描风', '国画风'],
                    digital: ['数字艺术', '概念设计', '插画风', '卡通风']
                }
            },
            scene: {
                daily: {
                    home: ['客厅', '卧室', '厨房', '阳台'],
                    outdoor: ['街道', '公园', '咖啡厅', '商场']
                },
                work: {
                    office: ['会议室', '办公桌', '接待区', '休息区'],
                    studio: ['摄影棚', '工作室', '展厅', '后台']
                }
            },
            outfit: {
                top: {
                    shirt: ['T恤', '衬衫', '背心', '吊带'],
                    sweater: ['毛衣', '卫衣', '开衫', '马甲']
                },
                bottom: {
                    pants: ['牛仔裤', '休闲裤', '正装裤', '运动裤'],
                    skirt: ['短裙', '长裙', '百褶裙', 'A字裙']
                }
            }
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadFromLocalStorage();
            validateForm();
        });

        function initializeEventListeners() {
            // 主图上传
            const mainUploadArea = document.getElementById('mainUploadArea');
            const mainImageInput = document.getElementById('mainImageInput');

            mainUploadArea.addEventListener('click', () => mainImageInput.click());
            mainUploadArea.addEventListener('dragover', handleDragOver);
            mainUploadArea.addEventListener('drop', handleMainImageDrop);
            mainImageInput.addEventListener('change', handleMainImageSelect);

            // 参考图上传
            document.querySelectorAll('.reference-upload').forEach(area => {
                area.addEventListener('click', () => handleReferenceUploadClick(area));
                area.addEventListener('dragover', handleDragOver);
                area.addEventListener('drop', (e) => handleReferenceImageDrop(e, area));
            });

            // 图片类型切换
            document.querySelectorAll('input[name="reference_type"]').forEach(radio => {
                radio.addEventListener('change', handleReferenceTypeChange);
            });

            // 服装类别级联
            document.addEventListener('change', function(e) {
                if (e.target.name === 'outfit_type_level1') {
                    updateOutfitLevel2(e.target);
                } else if (e.target.name === 'outfit_type_level2') {
                    updateOutfitLevel3(e.target);
                }
            });

            // 风格和场合标签级联
            document.addEventListener('change', function(e) {
                if (e.target.name === 'style_level1') {
                    updateStyleLevel2(e.target);
                } else if (e.target.name === 'style_level2') {
                    updateStyleTagWall(e.target);
                } else if (e.target.name === 'scene_level1') {
                    updateSceneLevel2(e.target);
                } else if (e.target.name === 'scene_level2') {
                    updateSceneTagWall(e.target);
                }
            });

            // 表单提交
            document.getElementById('annotationForm').addEventListener('submit', handleSubmit);

            // 表单变化监听
            document.addEventListener('input', saveToLocalStorage);
            document.addEventListener('change', saveToLocalStorage);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleMainImageDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleMainImageFile(files[0]);
            }
        }

        function handleMainImageSelect(e) {
            if (e.target.files.length > 0) {
                handleMainImageFile(e.target.files[0]);
            }
        }

        function handleMainImageFile(file) {
            if (!file.type.match('image/(png|jpeg)')) {
                alert('请上传PNG或JPG格式的图片');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    if (img.width < 1920 || img.height < 1080) {
                        alert('图片分辨率必须至少为1920×1080');
                        return;
                    }
                    if (img.width > 3840 || img.height > 2160) {
                        alert('图片分辨率不能超过3840×2160');
                        return;
                    }

                    mainImage = {
                        file: file,
                        url: e.target.result,
                        s3_url: `https://mock-s3.amazonaws.com/images/${Date.now()}-${file.name}`
                    };

                    displayMainImage();
                    updateImagePreview();
                    saveToLocalStorage();
                    validateForm();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayMainImage() {
            const preview = document.getElementById('mainImagePreview');
            preview.innerHTML = `<img src="${mainImage.url}" class="main-image-preview" alt="主图预览">`;
        }

        function handleReferenceUploadClick(area) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/jpeg';
            input.multiple = true;
            input.onchange = (e) => handleReferenceImageSelect(e, area);
            input.click();
        }

        function handleReferenceImageDrop(e, area) {
            e.preventDefault();
            area.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleReferenceImages(files, area.dataset.type);
        }

        function handleReferenceImageSelect(e, area) {
            const files = Array.from(e.target.files);
            handleReferenceImages(files, area.dataset.type);
        }

        function handleReferenceImages(files, type) {
            files.forEach(file => {
                if (!file.type.match('image/(png|jpeg)')) {
                    alert(`${file.name}: 请上传PNG或JPG格式的图片`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        file: file,
                        url: e.target.result,
                        s3_url: `https://mock-s3.amazonaws.com/images/${Date.now()}-${file.name}`,
                        description: ''
                    };

                    referenceImages[type].push(imageData);
                    updateReferenceCount(type);
                    updateImagePreview();
                    createDescriptionInput(type, referenceImages[type].length - 1);
                    saveToLocalStorage();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateReferenceCount(type) {
            const countElement = document.getElementById(`${type}Count`);
            countElement.textContent = `已上传: ${referenceImages[type].length}张`;
        }

        function createDescriptionInput(type, index) {
            const container = document.getElementById(`${type}Descriptions`);
            const div = document.createElement('div');
            div.innerHTML = `
                <input type="text" class="form-control" 
                       placeholder="图片描述 (选填)" 
                       style="margin-top: 10px;"
                       data-type="${type}" 
                       data-index="${index}"
                       onchange="updateImageDescription('${type}', ${index}, this.value)">
            `;
            container.appendChild(div);
        }

        function updateImageDescription(type, index, value) {
            if (referenceImages[type][index]) {
                referenceImages[type][index].description = value;
                saveToLocalStorage();
            }
        }

        function updateImagePreview() {
            const preview = document.getElementById('allImagesPreview');
            let html = '';

            // 主图
            if (mainImage) {
                html += `<img src="${mainImage.url}" class="preview-image" alt="主图" title="主图">`;
            }

            // 参考图
            Object.values(referenceImages).forEach(images => {
                images.forEach(img => {
                    html += `<img src="${img.url}" class="preview-image" alt="参考图" title="参考图">`;
                });
            });

            preview.innerHTML = html;
        }

        function handleReferenceTypeChange(e) {
            const isGenerated = e.target.value === '1';
            document.getElementById('generatedSection').style.display = isGenerated ? 'block' : 'none';
            document.getElementById('matchingSection').style.display = isGenerated ? 'none' : 'block';
            validateForm();
        }

        function updateOutfitLevel2(select) {
            const level2Select = select.parentNode.querySelector('select[name="outfit_type_level2"]');
            const level3Select = select.parentNode.querySelector('select[name="outfit_type_level3"]');
            
            level2Select.innerHTML = '<option value="">选择二级类别</option>';
            level3Select.innerHTML = '<option value="">选择三级类别</option>';
            level3Select.disabled = true;
            
            if (select.value && mockTagData.outfit[select.value]) {
                level2Select.disabled = false;
                Object.keys(mockTagData.outfit[select.value]).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    level2Select.appendChild(option);
                });
            } else {
                level2Select.disabled = true;
            }
        }

        function updateOutfitLevel3(select) {
            const level1Value = select.parentNode.querySelector('select[name="outfit_type_level1"]').value;
            const level3Select = select.parentNode.querySelector('select[name="outfit_type_level3"]');
            
            level3Select.innerHTML = '<option value="">选择三级类别</option>';
            
            if (select.value && mockTagData.outfit[level1Value] && mockTagData.outfit[level1Value][select.value]) {
                level3Select.disabled = false;
                mockTagData.outfit[level1Value][select.value].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    level3Select.appendChild(option);
                });
            } else {
                level3Select.disabled = true;
            }
        }

        function updateStyleLevel2(select) {
            const container = select.parentNode;
            const level2Select = container.querySelector('select[name="style_level2"]');
            const tagWall = container.querySelector('.tag-wall');
            
            level2Select.innerHTML = '<option value="">选择二级风格</option>';
            tagWall.innerHTML = '';
            
            if (select.value && mockTagData.style[select.value]) {
                level2Select.disabled = false;
                Object.keys(mockTagData.style[select.value]).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    level2Select.appendChild(option);
                });
            } else {
                level2Select.disabled = true;
            }
        }

        function updateStyleTagWall(select) {
            const container = select.parentNode;
            const level1Value = container.querySelector('select[name="style_level1"]').value;
            const tagWall = container.querySelector('.tag-wall');
            
            tagWall.innerHTML = '';
            
            if (select.value && mockTagData.style[level1Value] && mockTagData.style[level1Value][select.value]) {
                mockTagData.style[level1Value][select.value].forEach(tag => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'tag-item';
                    button.textContent = tag;
                    button.onclick = () => toggleTag(button);
                    tagWall.appendChild(button);
                });
            }
        }

        function updateSceneLevel2(select) {
            const container = select.parentNode;
            const level2Select = container.querySelector('select[name="scene_level2"]');
            const tagWall = container.querySelector('.tag-wall');
            
            level2Select.innerHTML = '<option value="">选择二级场合</option>';
            tagWall.innerHTML = '';
            
            if (select.value && mockTagData.scene[select.value]) {
                level2Select.disabled = false;
                Object.keys(mockTagData.scene[select.value]).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = key;
                    level2Select.appendChild(option);
                });
            } else {
                level2Select.disabled = true;
            }
        }

        function updateSceneTagWall(select) {
            const container = select.parentNode;
            const level1Value = container.querySelector('select[name="scene_level1"]').value;
            const tagWall = container.querySelector('.tag-wall');
            
            tagWall.innerHTML = '';
            
            if (select.value && mockTagData.scene[level1Value] && mockTagData.scene[level1Value][select.value]) {
                mockTagData.scene[level1Value][select.value].forEach(tag => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'tag-item';
                    button.textContent = tag;
                    button.onclick = () => toggleTag(button);
                    tagWall.appendChild(button);
                });
            }
        }

        function toggleTag(button) {
            button.classList.toggle('selected');
            saveToLocalStorage();
            validateForm();
        }

        function addStyleTag() {
            const container = document.getElementById('styleTagsContainer');
            const newTag = document.createElement('div');
            newTag.className = 'tag-selection';
            newTag.id = `styleTag${styleTagCounter}`;
            newTag.innerHTML = `
                <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <button type="button" class="remove-button" onclick="removeStyleTag(${styleTagCounter})" style="margin-bottom: 10px;">删除此项</button>
                    <select class="form-control" name="style_level1" style="margin-bottom: 10px;">
                        <option value="">选择一级风格</option>
                        <option value="realistic">写实</option>
                        <option value="artistic">艺术</option>
                        <option value="cartoon">卡通</option>
                    </select>
                    <select class="form-control" name="style_level2" style="margin-bottom: 10px;" disabled>
                        <option value="">选择二级风格</option>
                    </select>
                    <div class="tag-wall" id="styleTagWall${styleTagCounter}"></div>
                </div>
            `;
            container.appendChild(newTag);
            styleTagCounter++;
        }

        function removeStyleTag(id) {
            const element = document.getElementById(`styleTag${id}`);
            if (element) {
                element.remove();
                saveToLocalStorage();
                validateForm();
            }
        }

        function addSceneTag() {
            const container = document.getElementById('sceneTagsContainer');
            const newTag = document.createElement('div');
            newTag.className = 'tag-selection';
            newTag.id = `sceneTag${sceneTagCounter}`;
            newTag.innerHTML = `
                <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <button type="button" class="remove-button" onclick="removeSceneTag(${sceneTagCounter})" style="margin-bottom: 10px;">删除此项</button>
                    <select class="form-control" name="scene_level1" style="margin-bottom: 10px;">
                        <option value="">选择一级场合</option>
                        <option value="daily">日常</option>
                        <option value="work">工作</option>
                        <option value="party">聚会</option>
                        <option value="outdoor">户外</option>
                    </select>
                    <select class="form-control" name="scene_level2" style="margin-bottom: 10px;" disabled>
                        <option value="">选择二级场合</option>
                    </select>
                    <div class="tag-wall" id="sceneTagWall${sceneTagCounter}"></div>
                </div>
            `;
            container.appendChild(newTag);
            sceneTagCounter++;
        }

        function removeSceneTag(id) {
            const element = document.getElementById(`sceneTag${id}`);
            if (element) {
                element.remove();
                saveToLocalStorage();
                validateForm();
            }
        }

        function addOutfitDetail() {
            const container = document.getElementById('outfitDetailsContainer');
            const newOutfit = document.createElement('div');
            newOutfit.className = 'outfit-item';
            newOutfit.id = `outfit${outfitCounter}`;
            newOutfit.innerHTML = `
                <button type="button" class="remove-button" onclick="removeOutfit(${outfitCounter})">删除</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>服饰类别 <span class="required">*</span></label>
                        <select class="form-control outfit-type" name="outfit_type_level1" required>
                            <option value="">选择一级类别</option>
                            <option value="top">上装</option>
                            <option value="bottom">下装</option>
                            <option value="dress">连衣裙</option>
                            <option value="outerwear">外套</option>
                        </select>
                        <select class="form-control" name="outfit_type_level2" style="margin-top: 10px;" disabled>
                            <option value="">选择二级类别</option>
                        </select>
                        <select class="form-control" name="outfit_type_level3" style="margin-top: 10px;" disabled>
                            <option value="">选择三级类别</option>
                        </select>
                    </div>
                    <div>
                        <label>服饰材质 (选择最主要的一项)</label>
                        <select class="form-control" name="fabric_tag_ids">
                            <option value="">选择材质</option>
                            <option value="cotton">棉</option>
                            <option value="silk">丝绸</option>
                            <option value="wool">羊毛</option>
                            <option value="polyester">涤纶</option>
                            <option value="denim">牛仔布</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>服饰版型</label>
                        <select class="form-control" name="fit_tag_ids">
                            <option value="">选择版型</option>
                            <option value="slim">修身</option>
                            <option value="regular">标准</option>
                            <option value="loose">宽松</option>
                            <option value="oversized">超宽松</option>
                        </select>
                    </div>
                    <div>
                        <label>颜色标签</label>
                        <select class="form-control" name="color_tag_ids">
                            <option value="">选择颜色</option>
                            <option value="black">黑色</option>
                            <option value="white">白色</option>
                            <option value="red">红色</option>
                            <option value="blue">蓝色</option>
                            <option value="green">绿色</option>
                            <option value="yellow">黄色</option>
                            <option value="pink">粉色</option>
                            <option value="gray">灰色</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(newOutfit);
            
            // 显示第一个服装的删除按钮
            if (outfitCounter === 1) {
                document.querySelector('#outfit0 .remove-button').style.display = 'inline-block';
            }
            
            outfitCounter++;
            saveToLocalStorage();
            validateForm();
        }

        function removeOutfit(id) {
            const element = document.getElementById(`outfit${id}`);
            if (element) {
                element.remove();
                saveToLocalStorage();
                validateForm();
                
                // 如果只剩一个服装，隐藏删除按钮
                const remaining = document.querySelectorAll('.outfit-item');
                if (remaining.length === 1) {
                    remaining[0].querySelector('.remove-button').style.display = 'none';
                }
            }
        }

        function validateForm() {
            const submitButton = document.getElementById('submitButton');
            let isValid = true;

            // 检查主图
            if (!mainImage) {
                isValid = false;
            }

            // 检查图片类型
            const referenceType = document.querySelector('input[name="reference_type"]:checked');
            if (!referenceType) {
                isValid = false;
            } else {
                // 检查对应的必填字段
                if (referenceType.value === '1') {
                    // 生成图必填字段
                    const prompt = document.getElementById('contentPrompt').value.trim();
                    const model = document.getElementById('mlModel').value.trim();
                    if (!prompt || !model) {
                        isValid = false;
                    }
                } else {
                    // 匹配图必填字段
                    const faceSwitch = document.querySelector('input[name="can_be_used_for_face_switching"]:checked');
                    if (!faceSwitch) {
                        isValid = false;
                    }
                }
            }

            // 检查风格标签
            const styleSelections = document.querySelectorAll('#styleTagsContainer .tag-selection');
            let hasStyleTag = false;
            styleSelections.forEach(selection => {
                const selectedTags = selection.querySelectorAll('.tag-item.selected');
                if (selectedTags.length > 0) {
                    hasStyleTag = true;
                }
            });
            if (!hasStyleTag) {
                isValid = false;
            }

            // 检查场合标签
            const sceneSelections = document.querySelectorAll('#sceneTagsContainer .tag-selection');
            let hasSceneTag = false;
            sceneSelections.forEach(selection => {
                const selectedTags = selection.querySelectorAll('.tag-item.selected');
                if (selectedTags.length > 0) {
                    hasSceneTag = true;
                }
            });
            if (!hasSceneTag) {
                isValid = false;
            }

            // 检查模特数据
            const age = document.querySelector('select[name="age"]').value;
            const gender = document.querySelector('select[name="gender"]').value;
            const race = document.querySelector('select[name="race"]').value;
            const size = document.querySelector('select[name="size"]').value;
            if (!age || !gender || !race || !size) {
                isValid = false;
            }

            // 检查服装标注
            const outfitItems = document.querySelectorAll('.outfit-item');
            let hasValidOutfit = false;
            outfitItems.forEach(item => {
                const type1 = item.querySelector('select[name="outfit_type_level1"]').value;
                if (type1) {
                    hasValidOutfit = true;
                }
            });
            if (!hasValidOutfit) {
                isValid = false;
            }

            submitButton.disabled = !isValid;
        }

        function saveToLocalStorage() {
            const formData = {
                mainImage: mainImage,
                referenceImages: referenceImages,
                formValues: {}
            };

            // 保存表单数据
            const form = document.getElementById('annotationForm');
            const formElements = form.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                if (element.type === 'radio' || element.type === 'checkbox') {
                    formData.formValues[element.name + '_' + element.value] = element.checked;
                } else {
                    formData.formValues[element.name] = element.value;
                }
            });

            // 保存选中的标签
            const selectedTags = document.querySelectorAll('.tag-item.selected');
            formData.selectedTags = Array.from(selectedTags).map(tag => ({
                parent: tag.parentNode.id,
                text: tag.textContent
            }));

            localStorage.setItem('imageAnnotationData', JSON.stringify(formData));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('imageAnnotationData');
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                
                // 恢复主图
                if (data.mainImage) {
                    mainImage = data.mainImage;
                    displayMainImage();
                }

                // 恢复参考图
                if (data.referenceImages) {
                    referenceImages = data.referenceImages;
                    Object.keys(referenceImages).forEach(type => {
                        updateReferenceCount(type);
                        referenceImages[type].forEach((img, index) => {
                            createDescriptionInput(type, index);
                        });
                    });
                }

                updateImagePreview();

                // 恢复表单数据
                if (data.formValues) {
                    Object.keys(data.formValues).forEach(key => {
                        if (key.includes('_')) {
                            const [name, value] = key.split('_');
                            const element = document.querySelector(`input[name="${name}"][value="${value}"]`);
                            if (element) {
                                element.checked = data.formValues[key];
                                if (element.checked && element.type === 'radio') {
                                    element.dispatchEvent(new Event('change'));
                                }
                            }
                        } else {
                            const element = document.querySelector(`[name="${key}"]`);
                            if (element) {
                                element.value = data.formValues[key];
                                if (element.tagName === 'SELECT') {
                                    element.dispatchEvent(new Event('change'));
                                }
                            }
                        }
                    });
                }

                // 恢复选中的标签
                if (data.selectedTags) {
                    setTimeout(() => {
                        data.selectedTags.forEach(tagData => {
                            const parent = document.getElementById(tagData.parent);
                            if (parent) {
                                const tag = Array.from(parent.querySelectorAll('.tag-item'))
                                    .find(t => t.textContent === tagData.text);
                                if (tag) {
                                    tag.classList.add('selected');
                                }
                            }
                        });
                        validateForm();
                    }, 100);
                }

            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('imageAnnotationData');
        }

        function collectFormData() {
            const formData = {
                main_image: mainImage ? mainImage.s3_url : null,
                theme: document.getElementById('theme').value,
                reference_type: parseInt(document.querySelector('input[name="reference_type"]:checked')?.value || '0'),
            };

            // 根据图片类型添加相应字段
            if (formData.reference_type === 1) {
                // 生成图
                formData.content_prompt = document.getElementById('contentPrompt').value;
                formData.ml_model_source = document.getElementById('mlModel').value;
                
                // 参考图
                Object.keys(referenceImages).forEach(type => {
                    if (referenceImages[type].length > 0) {
                        formData[`${type}_images`] = referenceImages[type].map(img => img.s3_url);
                        formData[`${type}_description`] = referenceImages[type].map(img => img.description);
                    }
                });
            } else {
                // 匹配图
                formData.product_item_ids = document.getElementById('productIds').value;
                formData.pose_description = document.getElementById('poseDescription').value;
                formData.can_be_used_for_face_switching = document.querySelector('input[name="can_be_used_for_face_switching"]:checked')?.value === 'true';
            }

            // 风格标签
            formData.style_tag_ids = [];
            document.querySelectorAll('#styleTagsContainer .tag-selection').forEach(selection => {
                const selectedTags = Array.from(selection.querySelectorAll('.tag-item.selected'))
                    .map(tag => tag.textContent);
                formData.style_tag_ids.push(...selectedTags);
            });

            // 场合标签
            formData.scene_tag_ids = [];
            document.querySelectorAll('#sceneTagsContainer .tag-selection').forEach(selection => {
                const selectedTags = Array.from(selection.querySelectorAll('.tag-item.selected'))
                    .map(tag => tag.textContent);
                formData.scene_tag_ids.push(...selectedTags);
            });

            // 模特数据标签
            formData.model_attribute_tag_ids = {
                age: document.querySelector('select[name="age"]').value,
                gender: document.querySelector('select[name="gender"]').value,
                race: document.querySelector('select[name="race"]').value,
                size: document.querySelector('select[name="size"]').value
            };

            // 姿态标签
            formData.pose_tag_ids = document.getElementById('poseTag').value;

            // 构图标注
            formData.composition_annotation = {
                camera_type: document.querySelector('select[name="camera_type"]').value,
                body_ratio: document.querySelector('select[name="body_ratio"]').value,
                character_position: document.querySelector('select[name="character_position"]').value
            };

            // 服装标注
            formData.outfit_details = [];
            document.querySelectorAll('.outfit-item').forEach(item => {
                const outfit = {
                    outfit_type_tag_ids: {
                        level1: item.querySelector('select[name="outfit_type_level1"]').value,
                        level2: item.querySelector('select[name="outfit_type_level2"]').value,
                        level3: item.querySelector('select[name="outfit_type_level3"]').value
                    },
                    fabric_tag_ids: item.querySelector('select[name="fabric_tag_ids"]').value,
                    fit_tag_ids: item.querySelector('select[name="fit_tag_ids"]').value,
                    color_tag_ids: item.querySelector('select[name="color_tag_ids"]').value
                };
                formData.outfit_details.push(outfit);
            });

            return formData;
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = '上传中...';

            try {
                const formData = collectFormData();
                
                // 模拟API调用
                console.log('Submitting form data:', formData);
                
                // 模拟上传延迟
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 模拟成功响应
                const response = {
                    success: true,
                    message: '标注数据上传成功',
                    data: {
                        id: Date.now(),
                        ...formData
                    }
                };

                console.log('Upload response:', response);
                alert('标注数据上传成功！');
                
                // 清空表单和缓存
                document.getElementById('annotationForm').reset();
                mainImage = null;
                referenceImages = {
                    pose: [],
                    outfit: [],
                    scene: [],
                    composition: [],
                    style: []
                };
                
                // 清空预览
                document.getElementById('mainImagePreview').innerHTML = '';
                document.getElementById('allImagesPreview').innerHTML = '';
                
                // 重置计数器
                Object.keys(referenceImages).forEach(type => {
                    updateReferenceCount(type);
                    document.getElementById(`${type}Descriptions`).innerHTML = '';
                });
                
                // 重置条件区域
                document.getElementById('generatedSection').style.display = 'none';
                document.getElementById('matchingSection').style.display = 'none';
                
                clearLocalStorage();
                
            } catch (error) {
                console.error('Upload failed:', error);
                alert('上传失败，请重试');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '提交标注';
                validateForm();
            }
        }

        // 表单输入监听
        document.addEventListener('input', validateForm);
        document.addEventListener('change', validateForm);
    </script>
</body>
</html>