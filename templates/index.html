<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIBA 参考图标注工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow: hidden;
        }

        .right-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 40px);
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .main-image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .required {
            color: #e74c3c;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conditional-section {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .reference-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .reference-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .reference-upload {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .reference-upload:hover {
            border-color: #007bff;
        }

        .uploaded-count {
            color: #007bff;
            font-weight: bold;
            margin-top: 5px;
        }

        .tag-wall {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }

        .tag-item {
            padding: 6px 12px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .tag-item:hover {
            background: #dee2e6;
        }

        .tag-item.selected {
            background: #007bff;
            color: white;
        }

        .add-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-button:hover {
            background: #218838;
        }

        .submit-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 30px;
        }

        .submit-button:hover {
            background: #0056b3;
        }

        .submit-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #ddd;
        }

        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #856404;
            font-size: 12px;
        }

        .section-title {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }

        .outfit-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .remove-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .cascade-selects {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .cascade-selects select {
            flex: 1;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .reference-upload-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div>处理中...</div>
            <div style="margin-top: 10px;">请稍候</div>
        </div>
    </div>

    <div class="container">
        <!-- 左侧面板 -->
        <div class="left-panel">
            <h2>图片上传</h2>
            <div class="upload-area" id="mainUploadArea">
                <div>
                    <p>拖拽图片到这里或点击上传</p>
                    <p style="color: #666; font-size: 12px;">
                        支持格式：PNG, JPG<br>
                        <strong>竖屏要求：高度必须大于宽度</strong><br>
                        最小分辨率：1080×1920<br>
                        最大分辨率：2160×3840
                    </p>
                </div>
                <input type="file" id="mainImageInput" accept="image/png,image/jpeg" style="display: none;">
            </div>
            <div id="mainImagePreview"></div>
            
            <h3 style="margin-top: 20px;">已上传图片预览</h3>
            <div id="allImagesPreview" class="image-preview-grid"></div>
        </div>

        <!-- 右侧面板 -->
        <div class="right-panel">
            <h2>标注信息</h2>
            
            <div id="successMessage" class="success-message" style="display: none;"></div>
            
            <form id="annotationForm">
                <!-- 图片主题 -->
                <div class="form-group">
                    <label for="theme">图片所属主题 (选填)</label>
                    <select class="form-control" id="theme" name="theme_ids" multiple>
                        <option value="">加载主题中...</option>
                    </select>
                    <div class="note">按住Ctrl/Cmd可多选</div>
                </div>

                <!-- 图片类型 -->
                <div class="form-group">
                    <label>图片类型 <span class="required">*</span></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="generated" name="reference_type" value="1" required>
                            <label for="generated">生成图</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="matching" name="reference_type" value="2" required>
                            <label for="matching">匹配图</label>
                        </div>
                    </div>
                </div>

                <!-- 生成图条件区域 -->
                <div id="generatedSection" class="conditional-section">
                    <h3 class="section-title">生成图信息</h3>
                    
                    <div class="form-group">
                        <label for="gen_content_prompt">生成时所用的提示词 <span class="required">*</span></label>
                        <textarea class="form-control" id="gen_content_prompt" name="gen_content_prompt" rows="3" placeholder="请输入生成图片时使用的提示词"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="gen_ml_model_source">使用模型 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="gen_ml_model_source" name="gen_ml_model_source" placeholder="请输入模型名称或URL">
                    </div>

                    <div class="reference-upload-grid">
                        <!-- 姿态参考 -->
                        <div class="reference-item">
                            <h4>姿态参考</h4>
                            <div class="reference-upload" data-type="prompt_pose">
                                <p>上传姿态参考图</p>
                                <div class="uploaded-count" id="poseCount">已上传: 0张</div>
                            </div>
                            <textarea class="form-control" id="gen_pose_description" placeholder="姿态描述 (选填)" rows="2" style="margin-top: 10px;"></textarea>
                        </div>

                        <!-- 商品参考 -->
                        <div class="reference-item">
                            <h4>商品参考</h4>
                            <div class="reference-upload" data-type="prompt_outfit">
                                <p>上传商品参考图</p>
                                <div class="uploaded-count" id="outfitCount">已上传: 0张</div>
                            </div>
                            <textarea class="form-control" id="gen_outfit_description" placeholder="商品描述 (选填)" rows="2" style="margin-top: 10px;"></textarea>
                        </div>

                        <!-- 场景参考 -->
                        <div class="reference-item">
                            <h4>场景参考</h4>
                            <div class="reference-upload" data-type="prompt_scene">
                                <p>上传场景参考图</p>
                                <div class="uploaded-count" id="sceneCount">已上传: 0张</div>
                            </div>
                            <textarea class="form-control" id="gen_scene_description" placeholder="场景描述 (选填)" rows="2" style="margin-top: 10px;"></textarea>
                        </div>

                        <!-- 构图参考 -->
                        <div class="reference-item">
                            <h4>构图参考</h4>
                            <div class="reference-upload" data-type="prompt_composition">
                                <p>上传构图参考图</p>
                                <div class="uploaded-count" id="compositionCount">已上传: 0张</div>
                            </div>
                            <textarea class="form-control" id="gen_composition_description" placeholder="构图描述 (选填)" rows="2" style="margin-top: 10px;"></textarea>
                        </div>

                        <!-- 风格参考 -->
                        <div class="reference-item">
                            <h4>风格参考</h4>
                            <div class="reference-upload" data-type="prompt_style">
                                <p>上传风格参考图</p>
                                <div class="uploaded-count" id="styleCount">已上传: 0张</div>
                            </div>
                            <textarea class="form-control" id="gen_style_description" placeholder="风格描述 (选填)" rows="2" style="margin-top: 10px;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 匹配图条件区域 -->
                <div id="matchingSection" class="conditional-section">
                    <h3 class="section-title">匹配图信息</h3>
                    
                    <div class="form-group">
                        <label for="product_item_ids">商品ID (选填，多个用逗号分隔)</label>
                        <input type="text" class="form-control" id="product_item_ids" name="product_item_ids" placeholder="例如: SKU001,SKU002">
                    </div>

                    <div class="form-group">
                        <label for="pose_description">姿势描述 (选填)</label>
                        <textarea class="form-control" id="pose_description" name="pose_description" rows="3" placeholder="请描述图片中人物的姿势"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="scene_description">场景描述 (选填)</label>
                        <textarea class="form-control" id="scene_description" name="scene_description" rows="3" placeholder="请描述图片的场景"></textarea>
                    </div>

                    <div class="form-group">
                        <label>是否可被用于换脸 <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="faceYes" name="can_be_used_for_face_switching" value="true">
                                <label for="faceYes">是</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="faceNo" name="can_be_used_for_face_switching" value="false">
                                <label for="faceNo">否</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 风格标签 -->
                <div class="form-group">
                    <label>风格标签 <span class="required">*</span></label>
                    <div class="note">注意：这是指整体图片的艺术风格，不是衣服的风格</div>
                    <div id="styleTagsContainer"></div>
                </div>

                <!-- 场合标签 -->
                <div class="form-group">
                    <label>场合标签 <span class="required">*</span></label>
                    <div id="occasionTagsContainer"></div>
                </div>

                <!-- 模特数据标签 -->
                <div class="form-group">
                    <label>模特数据标签 <span class="required">*</span></label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                        <div>
                            <label>年龄</label>
                            <select class="form-control" id="model_age" name="model_age" required>
                                <option value="">选择年龄</option>
                            </select>
                        </div>
                        <div>
                            <label>性别</label>
                            <select class="form-control" id="model_gender" name="model_gender" required>
                                <option value="">选择性别</option>
                            </select>
                        </div>
                        <div>
                            <label>种族</label>
                            <select class="form-control" id="model_race" name="model_race" required>
                                <option value="">选择种族</option>
                            </select>
                        </div>
                        <div>
                            <label>体型</label>
                            <select class="form-control" id="model_size" name="model_size" required>
                                <option value="">选择体型</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 姿态标签 -->
                <div class="form-group">
                    <label for="pose_tags">姿态标签 (选填)</label>
                    <select class="form-control" id="pose_tags" name="pose_tag_ids" multiple>
                        <option value="">加载中...</option>
                    </select>
                    <div class="note">按住Ctrl/Cmd可多选</div>
                </div>

                <!-- 服装标注 -->
                <div class="form-group">
                    <label>服装标注 <span class="required">*</span></label>
                    <div id="outfitDetailsContainer">
                        <!-- 动态生成 -->
                    </div>
                    <button type="button" class="add-button" onclick="addOutfitDetail()">+ 添加服装标注</button>
                </div>

                <button type="submit" class="submit-button" id="submitButton" disabled>提交标注</button>
            </form>
        </div>
    </div>

    <script>
        // API配置
        const API_BASE_URL = '/api';
        
        // 全局变量
        let mainImage = null;
        let referenceImages = {
            prompt_pose: [],
            prompt_outfit: [],
            prompt_scene: [],
            prompt_composition: [],
            prompt_style: []
        };
        let tagData = null;
        let themes = [];
        let outfitCounter = 0;

        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading();
            try {
                await loadAllData();
                initializeEventListeners();
                addOutfitDetail(); // 添加默认的第一个服装项
            } catch (error) {
                console.error('Initialization error:', error);
                alert('初始化失败，请刷新页面重试');
            } finally {
                hideLoading();
            }
        });

        // 显示/隐藏加载动画
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // 加载所有数据
        async function loadAllData() {
            try {
                // 并行加载主题和标签数据
                const [themesResponse, tagsResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/themes`),
                    fetch(`${API_BASE_URL}/tags/all`)
                ]);

                if (!themesResponse.ok || !tagsResponse.ok) {
                    throw new Error('Failed to load data');
                }

                const themesData = await themesResponse.json();
                const tagsData = await tagsResponse.json();

                if (themesData.success) {
                    themes = themesData.data;
                    populateThemes();
                }

                if (tagsData.success) {
                    tagData = tagsData.data;
                    populateTags();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                throw error;
            }
        }

        // 填充主题选择器
        function populateThemes() {
            const themeSelect = document.getElementById('theme');
            themeSelect.innerHTML = '<option value="">不选择主题</option>';
            
            themes.forEach(theme => {
                const option = document.createElement('option');
                option.value = theme.unique_id;
                option.textContent = theme.title;
                themeSelect.appendChild(option);
            });
        }

        // 填充标签选择器
        function populateTags() {
            if (!tagData) return;

            // 填充单级标签
            populateSingleLevelTags();
            
            // 初始化多级标签容器
            initializeMultiLevelTags();
        }

        // 填充单级标签
        function populateSingleLevelTags() {
            // 模特年龄
            if (tagData.single_level.model_age) {
                populateSelect('model_age', tagData.single_level.model_age.list);
            }

            // 模特性别
            if (tagData.single_level.model_gender) {
                populateSelect('model_gender', tagData.single_level.model_gender.list);
            }

            // 模特种族
            if (tagData.single_level.model_race) {
                populateSelect('model_race', tagData.single_level.model_race.list);
            }

            // 模特体型
            if (tagData.single_level.model_size) {
                populateSelect('model_size', tagData.single_level.model_size.list);
            }

            // 姿态标签
            if (tagData.single_level.pose) {
                const poseSelect = document.getElementById('pose_tags');
                poseSelect.innerHTML = '';
                tagData.single_level.pose.list.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = `${tag.name_cn} (${tag.name})`;
                    poseSelect.appendChild(option);
                });
            }
        }

        // 通用的填充选择器函数
        function populateSelect(selectId, tags) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">请选择</option>';
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.id;
                option.textContent = tag.name_cn || tag.name;
                select.appendChild(option);
            });
        }

        // 初始化多级标签
        function initializeMultiLevelTags() {
            // 风格标签
            if (tagData.multi_level.style) {
                const styleContainer = document.getElementById('styleTagsContainer');
                styleContainer.innerHTML = createMultiLevelTagSelector('style', tagData.multi_level.style);
            }

            // 场合标签
            if (tagData.multi_level.occasion) {
                const occasionContainer = document.getElementById('occasionTagsContainer');
                occasionContainer.innerHTML = createMultiLevelTagSelector('occasion', tagData.multi_level.occasion);
            }
        }

        // 创建多级标签选择器
        function createMultiLevelTagSelector(type, data) {
            let html = '<div class="cascade-selects">';
            
            // 一级选择器
            html += `<select class="form-control" id="${type}_level1" onchange="updateLevel2('${type}', this.value)">`;
            html += '<option value="">选择一级分类</option>';
            
            if (data.cascade && data.cascade.level1) {
                data.cascade.level1.forEach(item => {
                    html += `<option value="${item.value}">${item.label}</option>`;
                });
            }
            
            html += '</select>';
            
            // 二级选择器
            html += `<select class="form-control" id="${type}_level2" onchange="updateLevel3('${type}', this.value)" disabled>`;
            html += '<option value="">选择二级分类</option>';
            html += '</select>';
            
            // 三级选择器（如果有）
            html += `<select class="form-control" id="${type}_level3" onchange="updateLevel4('${type}', this.value)" disabled>`;
            html += '<option value="">选择三级分类</option>';
            html += '</select>';
            
            // 四级选择器（如果有）
            html += `<select class="form-control" id="${type}_level4" onchange="selectTag('${type}', this.value)" disabled>`;
            html += '<option value="">选择四级分类</option>';
            html += '</select>';
            
            html += '</div>';
            
            // 已选标签展示区
            html += `<div class="tag-wall" id="${type}_selected_tags"></div>`;
            
            return html;
        }

        // 更新二级选择器
        function updateLevel2(type, parentId) {
            const level2Select = document.getElementById(`${type}_level2`);
            const level3Select = document.getElementById(`${type}_level3`);
            const level4Select = document.getElementById(`${type}_level4`);
            
            level2Select.innerHTML = '<option value="">选择二级分类</option>';
            level3Select.innerHTML = '<option value="">选择三级分类</option>';
            level4Select.innerHTML = '<option value="">选择四级分类</option>';
            level3Select.disabled = true;
            level4Select.disabled = true;
            
            if (!parentId) {
                level2Select.disabled = true;
                return;
            }
            
            const data = tagData.multi_level[type];
            if (data && data.cascade && data.cascade.level2_by_parent && data.cascade.level2_by_parent[parentId]) {
                level2Select.disabled = false;
                data.cascade.level2_by_parent[parentId].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    level2Select.appendChild(option);
                });
            }
        }

        // 更新三级选择器
        function updateLevel3(type, parentId) {
            const level3Select = document.getElementById(`${type}_level3`);
            const level4Select = document.getElementById(`${type}_level4`);
            
            level3Select.innerHTML = '<option value="">选择三级分类</option>';
            level4Select.innerHTML = '<option value="">选择四级分类</option>';
            level4Select.disabled = true;
            
            if (!parentId) {
                level3Select.disabled = true;
                return;
            }
            
            const data = tagData.multi_level[type];
            if (data && data.cascade && data.cascade.level3_by_parent && data.cascade.level3_by_parent[parentId]) {
                level3Select.disabled = false;
                data.cascade.level3_by_parent[parentId].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    level3Select.appendChild(option);
                });
            } else {
                // 如果没有三级，直接选中二级
                selectTag(type, parentId);
            }
        }

        // 更新四级选择器
        function updateLevel4(type, parentId) {
            const level4Select = document.getElementById(`${type}_level4`);
            
            level4Select.innerHTML = '<option value="">选择四级分类</option>';
            
            if (!parentId) {
                level4Select.disabled = true;
                return;
            }
            
            const data = tagData.multi_level[type];
            if (data && data.cascade && data.cascade.level4_by_parent && data.cascade.level4_by_parent[parentId]) {
                level4Select.disabled = false;
                data.cascade.level4_by_parent[parentId].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    level4Select.appendChild(option);
                });
            } else {
                // 如果没有四级，直接选中三级
                selectTag(type, parentId);
            }
        }

        // 选择标签
        function selectTag(type, tagId) {
            if (!tagId) return;
            
            const selectedContainer = document.getElementById(`${type}_selected_tags`);
            
            // 检查是否已选择
            if (selectedContainer.querySelector(`[data-tag-id="${tagId}"]`)) {
                return;
            }
            
            // 获取标签信息
            const data = tagData.multi_level[type];
            const tagInfo = data.flat[tagId];
            
            if (tagInfo) {
                const tagElement = document.createElement('button');
                tagElement.type = 'button';
                tagElement.className = 'tag-item selected';
                tagElement.setAttribute('data-tag-id', tagId);
                tagElement.textContent = tagInfo.name_cn || tagInfo.name;
                tagElement.onclick = function() {
                    this.remove();
                    validateForm();
                };
                selectedContainer.appendChild(tagElement);
                
                validateForm();
            }
        }

        // 添加服装详情项
        function addOutfitDetail() {
            const container = document.getElementById('outfitDetailsContainer');
            const outfitId = `outfit_${outfitCounter}`;
            
            const outfitItem = document.createElement('div');
            outfitItem.className = 'outfit-item';
            outfitItem.id = outfitId;
            
            let html = '';
            if (outfitCounter > 0) {
                html += `<button type="button" class="remove-button" onclick="removeOutfit('${outfitId}')">删除</button>`;
            }
            
            html += `
                <div style="margin-bottom: 15px;">
                    <label>产品类型 <span class="required">*</span></label>
                    <div class="cascade-selects" id="${outfitId}_product_type">
                        <select class="form-control" onchange="updateProductLevel2('${outfitId}', this.value)">
                            <option value="">选择一级</option>
                        </select>
                        <select class="form-control" disabled>
                            <option value="">选择二级</option>
                        </select>
                        <select class="form-control" disabled>
                            <option value="">选择三级</option>
                        </select>
                        <select class="form-control" disabled>
                            <option value="">选择四级</option>
                        </select>
                    </div>
                    <div class="tag-wall" id="${outfitId}_product_selected"></div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>面料材质</label>
                        <select class="form-control" id="${outfitId}_fabric">
                            <option value="">选择面料</option>
                        </select>
                    </div>
                    <div>
                        <label>廓形版型</label>
                        <div class="cascade-selects" id="${outfitId}_silhouette">
                            <select class="form-control" onchange="updateSilhouetteLevel2('${outfitId}', this.value)">
                                <option value="">选择廓形</option>
                            </select>
                        </div>
                        <div class="tag-wall" id="${outfitId}_silhouette_selected"></div>
                    </div>
                </div>
            `;
            
            outfitItem.innerHTML = html;
            container.appendChild(outfitItem);
            
            // 填充产品类型选项
            if (tagData && tagData.multi_level.product_type) {
                const productSelect = outfitItem.querySelector(`#${outfitId}_product_type select`);
                tagData.multi_level.product_type.cascade.level1.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    productSelect.appendChild(option);
                });
            }
            
            // 填充面料选项
            if (tagData && tagData.single_level.fabric) {
                const fabricSelect = document.getElementById(`${outfitId}_fabric`);
                tagData.single_level.fabric.list.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name_cn || tag.name;
                    fabricSelect.appendChild(option);
                });
            }
            
            // 填充廓形选项
            if (tagData && tagData.multi_level.silhouette) {
                const silhouetteSelect = outfitItem.querySelector(`#${outfitId}_silhouette select`);
                tagData.multi_level.silhouette.cascade.level1.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    silhouetteSelect.appendChild(option);
                });
            }
            
            outfitCounter++;
            validateForm();
        }

        // 更新产品类型级联
        function updateProductLevel2(outfitId, parentId) {
            const container = document.getElementById(`${outfitId}_product_type`);
            const selects = container.querySelectorAll('select');
            const level2Select = selects[1];
            const level3Select = selects[2];
            const level4Select = selects[3];
            
            level2Select.innerHTML = '<option value="">选择二级</option>';
            level3Select.innerHTML = '<option value="">选择三级</option>';
            level4Select.innerHTML = '<option value="">选择四级</option>';
            level3Select.disabled = true;
            level4Select.disabled = true;
            
            if (!parentId) {
                level2Select.disabled = true;
                return;
            }
            
            const data = tagData.multi_level.product_type;
            if (data && data.cascade && data.cascade.level2_by_parent && data.cascade.level2_by_parent[parentId]) {
                level2Select.disabled = false;
                data.cascade.level2_by_parent[parentId].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    level2Select.appendChild(option);
                });
                
                // 绑定事件
                level2Select.onchange = function() {
                    updateProductLevel3(outfitId, this.value);
                };
            }
        }

        // 更新产品类型第三级
        function updateProductLevel3(outfitId, parentId) {
            const container = document.getElementById(`${outfitId}_product_type`);
            const selects = container.querySelectorAll('select');
            const level3Select = selects[2];
            const level4Select = selects[3];
            
            level3Select.innerHTML = '<option value="">选择三级</option>';
            level4Select.innerHTML = '<option value="">选择四级</option>';
            level4Select.disabled = true;
            
            if (!parentId) {
                level3Select.disabled = true;
                return;
            }
            
            const data = tagData.multi_level.product_type;
            if (data && data.cascade && data.cascade.level3_by_parent && data.cascade.level3_by_parent[parentId]) {
                level3Select.disabled = false;
                data.cascade.level3_by_parent[parentId].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    level3Select.appendChild(option);
                });
                
                level3Select.onchange = function() {
                    updateProductLevel4(outfitId, this.value);
                };
            } else {
                selectProductTag(outfitId, parentId);
            }
        }

        // 更新产品类型第四级
        function updateProductLevel4(outfitId, parentId) {
            const container = document.getElementById(`${outfitId}_product_type`);
            const selects = container.querySelectorAll('select');
            const level4Select = selects[3];
            
            level4Select.innerHTML = '<option value="">选择四级</option>';
            
            if (!parentId) {
                level4Select.disabled = true;
                return;
            }
            
            const data = tagData.multi_level.product_type;
            if (data && data.cascade && data.cascade.level4_by_parent && data.cascade.level4_by_parent[parentId]) {
                level4Select.disabled = false;
                data.cascade.level4_by_parent[parentId].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    level4Select.appendChild(option);
                });
                
                level4Select.onchange = function() {
                    selectProductTag(outfitId, this.value);
                };
            } else {
                selectProductTag(outfitId, parentId);
            }
        }

        // 选择产品标签
        function selectProductTag(outfitId, tagId) {
            if (!tagId) return;
            
            const selectedContainer = document.getElementById(`${outfitId}_product_selected`);
            selectedContainer.innerHTML = ''; // 只保留一个
            
            const data = tagData.multi_level.product_type;
            const tagInfo = data.flat[tagId];
            
            if (tagInfo) {
                const tagElement = document.createElement('button');
                tagElement.type = 'button';
                tagElement.className = 'tag-item selected';
                tagElement.setAttribute('data-tag-id', tagId);
                tagElement.textContent = tagInfo.name_cn || tagInfo.name;
                tagElement.onclick = function() {
                    this.remove();
                    validateForm();
                };
                selectedContainer.appendChild(tagElement);
                
                validateForm();
            }
        }

        // 更新廓形级联
        function updateSilhouetteLevel2(outfitId, parentId) {
            // 简化版实现，可根据需要扩展
            selectSilhouetteTag(outfitId, parentId);
        }

        // 选择廓形标签
        function selectSilhouetteTag(outfitId, tagId) {
            if (!tagId) return;
            
            const selectedContainer = document.getElementById(`${outfitId}_silhouette_selected`);
            selectedContainer.innerHTML = ''; // 只保留一个
            
            const data = tagData.multi_level.silhouette;
            if (data && data.flat[tagId]) {
                const tagInfo = data.flat[tagId];
                const tagElement = document.createElement('button');
                tagElement.type = 'button';
                tagElement.className = 'tag-item selected';
                tagElement.setAttribute('data-tag-id', tagId);
                tagElement.textContent = tagInfo.name_cn || tagInfo.name;
                tagElement.onclick = function() {
                    this.remove();
                    validateForm();
                };
                selectedContainer.appendChild(tagElement);
                
                validateForm();
            }
        }

        // 删除服装项
        function removeOutfit(outfitId) {
            const element = document.getElementById(outfitId);
            if (element) {
                element.remove();
                validateForm();
            }
        }

        // 初始化事件监听器
        function initializeEventListeners() {
            // 主图上传
            const mainUploadArea = document.getElementById('mainUploadArea');
            const mainImageInput = document.getElementById('mainImageInput');

            mainUploadArea.addEventListener('click', () => mainImageInput.click());
            mainUploadArea.addEventListener('dragover', handleDragOver);
            mainUploadArea.addEventListener('drop', handleMainImageDrop);
            mainUploadArea.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('dragover'));
            mainImageInput.addEventListener('change', handleMainImageSelect);

            // 参考图上传
            document.querySelectorAll('.reference-upload').forEach(area => {
                area.addEventListener('click', () => handleReferenceUploadClick(area));
                area.addEventListener('dragover', handleDragOver);
                area.addEventListener('drop', (e) => handleReferenceImageDrop(e, area));
                area.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('dragover'));
            });

            // 图片类型切换
            document.querySelectorAll('input[name="reference_type"]').forEach(radio => {
                radio.addEventListener('change', handleReferenceTypeChange);
            });

            // 表单提交
            document.getElementById('annotationForm').addEventListener('submit', handleSubmit);

            // 表单变化监听（用于验证）
            document.addEventListener('input', validateForm);
            document.addEventListener('change', validateForm);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleMainImageDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleMainImageFile(files[0]);
            }
        }

        function handleMainImageSelect(e) {
            if (e.target.files.length > 0) {
                handleMainImageFile(e.target.files[0]);
            }
        }

        async function handleMainImageFile(file) {
            if (!file.type.match('image/(png|jpeg|jpg)')) {
                alert('请上传PNG或JPG格式的图片');
                return;
            }

            // 验证图片尺寸（竖屏）
            const isValid = await validateImageDimensions(file);
            if (!isValid) {
                return;
            }

            // 上传到S3
            showLoading();
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('image_type', 'reference_image');

                const response = await fetch(`${API_BASE_URL}/upload-image`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    mainImage = {
                        file: file,
                        url: URL.createObjectURL(file),
                        s3_url: result.data.url,
                        image_info: result.data.image_info
                    };
                    
                    displayMainImage();
                    updateImagePreview();
                    validateForm();
                } else {
                    alert(`上传失败: ${result.error}`);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('上传失败，请重试');
            } finally {
                hideLoading();
            }
        }

        // 验证图片尺寸（竖屏要求）
        function validateImageDimensions(file) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    img.onload = function() {
                        // 检查是否为竖屏（高度 > 宽度）
                        if (img.width >= img.height) {
                            alert('请上传竖屏图片（高度必须大于宽度）');
                            resolve(false);
                            return;
                        }
                        
                        // 检查最小分辨率
                        if (img.width < 1080 || img.height < 1920) {
                            alert(`图片分辨率过低\n当前：${img.width}×${img.height}\n最小要求：1080×1920`);
                            resolve(false);
                            return;
                        }
                        
                        // 检查最大分辨率
                        if (img.width > 2160 || img.height > 3840) {
                            alert(`图片分辨率过高\n当前：${img.width}×${img.height}\n最大限制：2160×3840`);
                            resolve(false);
                            return;
                        }
                        
                        resolve(true);
                    };
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            });
        }

        function displayMainImage() {
            const preview = document.getElementById('mainImagePreview');
            const info = mainImage.image_info;
            preview.innerHTML = `
                <img src="${mainImage.url}" class="main-image-preview" alt="主图预览">
                <p style="margin-top: 10px; font-size: 12px; color: #666;">
                    尺寸：${info.width}×${info.height} | 
                    格式：${info.format} | 
                    大小：${info.file_size_mb}MB
                </p>
            `;
        }

        function handleReferenceUploadClick(area) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/jpeg';
            input.multiple = true;
            input.onchange = (e) => handleReferenceImageSelect(e, area);
            input.click();
        }

        function handleReferenceImageDrop(e, area) {
            e.preventDefault();
            area.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleReferenceImages(files, area.dataset.type);
        }

        function handleReferenceImageSelect(e, area) {
            const files = Array.from(e.target.files);
            handleReferenceImages(files, area.dataset.type);
        }

        async function handleReferenceImages(files, type) {
            showLoading();
            
            for (const file of files) {
                if (!file.type.match('image/(png|jpeg|jpg)')) {
                    alert(`${file.name}: 请上传PNG或JPG格式的图片`);
                    continue;
                }

                // 验证竖屏
                const isValid = await validateImageDimensions(file);
                if (!isValid) {
                    continue;
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('image_type', type);

                    const response = await fetch(`${API_BASE_URL}/upload-image`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // 映射类型名称
                        const mappedType = type.replace('prompt_', '');
                        
                        if (!referenceImages[type]) {
                            referenceImages[type] = [];
                        }
                        
                        referenceImages[type].push({
                            file: file,
                            url: URL.createObjectURL(file),
                            s3_url: result.data.url
                        });
                        
                        updateReferenceCount(mappedType);
                        updateImagePreview();
                    } else {
                        alert(`${file.name} 上传失败: ${result.error}`);
                    }
                } catch (error) {
                    console.error(`Error uploading ${file.name}:`, error);
                    alert(`${file.name} 上传失败`);
                }
            }
            
            hideLoading();
        }

        function updateReferenceCount(type) {
            const countElement = document.getElementById(`${type}Count`);
            if (countElement) {
                const fullType = `prompt_${type}`;
                const count = referenceImages[fullType] ? referenceImages[fullType].length : 0;
                countElement.textContent = `已上传: ${count}张`;
            }
        }

        function updateImagePreview() {
            const preview = document.getElementById('allImagesPreview');
            let html = '';

            // 主图
            if (mainImage) {
                html += `<img src="${mainImage.url}" class="preview-image" alt="主图" title="主图">`;
            }

            // 参考图
            Object.values(referenceImages).forEach(images => {
                if (Array.isArray(images)) {
                    images.forEach(img => {
                        html += `<img src="${img.url}" class="preview-image" alt="参考图" title="参考图">`;
                    });
                }
            });

            preview.innerHTML = html;
        }

        function handleReferenceTypeChange(e) {
            const isGenerated = e.target.value === '1';
            document.getElementById('generatedSection').style.display = isGenerated ? 'block' : 'none';
            document.getElementById('matchingSection').style.display = isGenerated ? 'none' : 'block';
            validateForm();
        }

        function validateForm() {
            const submitButton = document.getElementById('submitButton');
            let isValid = true;
            let errors = [];

            // 检查主图
            if (!mainImage) {
                isValid = false;
                errors.push('请上传主图');
            }

            // 检查图片类型
            const referenceType = document.querySelector('input[name="reference_type"]:checked');
            if (!referenceType) {
                isValid = false;
                errors.push('请选择图片类型');
            } else {
                // 检查对应的必填字段
                if (referenceType.value === '1') {
                    // 生成图必填字段
                    const prompt = document.getElementById('gen_content_prompt')?.value.trim();
                    const model = document.getElementById('gen_ml_model_source')?.value.trim();
                    if (!prompt || !model) {
                        isValid = false;
                        errors.push('请填写提示词和模型信息');
                    }
                } else {
                    // 匹配图必填字段
                    const faceSwitch = document.querySelector('input[name="can_be_used_for_face_switching"]:checked');
                    if (!faceSwitch) {
                        isValid = false;
                        errors.push('请选择是否可用于换脸');
                    }
                }
            }

            // 检查风格标签
            const styleSelectedTags = document.querySelectorAll('#style_selected_tags .tag-item');
            if (styleSelectedTags.length === 0) {
                isValid = false;
                errors.push('请选择至少一个风格标签');
            }

            // 检查场合标签
            const occasionSelectedTags = document.querySelectorAll('#occasion_selected_tags .tag-item');
            if (occasionSelectedTags.length === 0) {
                isValid = false;
                errors.push('请选择至少一个场合标签');
            }

            // 检查模特数据
            const modelFields = ['model_age', 'model_gender', 'model_race', 'model_size'];
            const missingModelFields = modelFields.filter(field => !document.getElementById(field)?.value);
            if (missingModelFields.length > 0) {
                isValid = false;
                errors.push('请完善模特数据');
            }

            // 检查服装标注
            const outfitItems = document.querySelectorAll('.outfit-item');
            let hasValidOutfit = false;
            outfitItems.forEach(item => {
                const productTags = item.querySelectorAll('[id$="_product_selected"] .tag-item');
                if (productTags.length > 0) {
                    hasValidOutfit = true;
                }
            });
            if (!hasValidOutfit) {
                isValid = false;
                errors.push('请至少添加一个服装标注');
            }

            submitButton.disabled = !isValid;
            
            // 更新按钮文字显示验证状态
            if (!isValid && errors.length > 0) {
                submitButton.title = errors.join('\n');
            } else {
                submitButton.title = '点击提交';
            }
        }

        // 收集表单数据
        function collectFormData() {
            const formData = {
                reference_image_url: mainImage ? mainImage.s3_url : null,
                reference_type: parseInt(document.querySelector('input[name="reference_type"]:checked')?.value || '0'),
            };

            // 主题
            const themeSelect = document.getElementById('theme');
            const selectedThemes = Array.from(themeSelect.selectedOptions).map(option => option.value).filter(v => v);
            if (selectedThemes.length > 0) {
                formData.theme_ids = selectedThemes;
            }

            // 根据图片类型添加相应字段
            if (formData.reference_type === 1) {
                // 生成图
                formData.gen_content_prompt = document.getElementById('gen_content_prompt').value;
                formData.gen_ml_model_source = document.getElementById('gen_ml_model_source').value;
                
                // 参考图URLs
                if (referenceImages.prompt_pose?.length > 0) {
                    formData.gen_pose_images = referenceImages.prompt_pose.map(img => img.s3_url);
                    formData.gen_pose_description = document.getElementById('gen_pose_description')?.value || null;
                }
                if (referenceImages.prompt_outfit?.length > 0) {
                    formData.gen_outfit_images = referenceImages.prompt_outfit.map(img => img.s3_url);
                    formData.gen_outfit_description = document.getElementById('gen_outfit_description')?.value || null;
                }
                if (referenceImages.prompt_scene?.length > 0) {
                    formData.gen_scene_images = referenceImages.prompt_scene.map(img => img.s3_url);
                    formData.gen_scene_description = document.getElementById('gen_scene_description')?.value || null;
                }
                if (referenceImages.prompt_composition?.length > 0) {
                    formData.gen_composition_images = referenceImages.prompt_composition.map(img => img.s3_url);
                    formData.gen_composition_description = document.getElementById('gen_composition_description')?.value || null;
                }
                if (referenceImages.prompt_style?.length > 0) {
                    formData.gen_style_images = referenceImages.prompt_style.map(img => img.s3_url);
                    formData.gen_style_description = document.getElementById('gen_style_description')?.value || null;
                }
            } else {
                // 匹配图
                const productIds = document.getElementById('product_item_ids').value;
                if (productIds) {
                    formData.product_item_ids = productIds.split(',').map(id => id.trim()).filter(id => id);
                }
                
                formData.pose_description = document.getElementById('pose_description').value || null;
                formData.scene_description = document.getElementById('scene_description').value || null;
                formData.can_be_used_for_face_switching = document.querySelector('input[name="can_be_used_for_face_switching"]:checked')?.value === 'true';
            }

            // 收集标签IDs
            // 风格标签
            formData.style_tag_ids = Array.from(document.querySelectorAll('#style_selected_tags .tag-item'))
                .map(tag => parseInt(tag.getAttribute('data-tag-id')));

            // 场合标签（映射到scene_tag_ids）
            formData.scene_tag_ids = Array.from(document.querySelectorAll('#occasion_selected_tags .tag-item'))
                .map(tag => parseInt(tag.getAttribute('data-tag-id')));

            // 模特属性标签
            const modelAttributes = [];
            ['model_age', 'model_gender', 'model_race', 'model_size'].forEach(field => {
                const value = document.getElementById(field)?.value;
                if (value) {
                    modelAttributes.push(parseInt(value));
                }
            });
            formData.model_attribute_tag_ids = modelAttributes;

            // 姿态标签
            const poseTags = document.getElementById('pose_tags');
            if (poseTags) {
                const selectedPoseTags = Array.from(poseTags.selectedOptions)
                    .map(option => parseInt(option.value))
                    .filter(v => v);
                if (selectedPoseTags.length > 0) {
                    formData.pose_tag_ids = selectedPoseTags;
                }
            }

            // 服装详情
            formData.outfit_details = [];
            document.querySelectorAll('.outfit-item').forEach(item => {
                const outfit = {};
                
                // 产品类型标签
                const productTag = item.querySelector('[id$="_product_selected"] .tag-item');
                if (productTag) {
                    outfit.outfit_type_tag_id = parseInt(productTag.getAttribute('data-tag-id'));
                }
                
                // 面料标签
                const fabricSelect = item.querySelector('[id$="_fabric"]');
                if (fabricSelect?.value) {
                    outfit.fabric_tag_id = parseInt(fabricSelect.value);
                }
                
                // 廓形标签
                const silhouetteTag = item.querySelector('[id$="_silhouette_selected"] .tag-item');
                if (silhouetteTag) {
                    outfit.fit_tag_id = parseInt(silhouetteTag.getAttribute('data-tag-id'));
                }
                
                if (Object.keys(outfit).length > 0) {
                    formData.outfit_details.push(outfit);
                }
            });

            return formData;
        }

        // 提交表单
        async function handleSubmit(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            submitButton.textContent = '提交中...';
            
            showLoading();

            try {
                const formData = collectFormData();
                
                console.log('Submitting form data:', formData);
                
                const response = await fetch(`${API_BASE_URL}/reference-images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // 显示成功消息
                    const successMsg = document.getElementById('successMessage');
                    successMsg.textContent = `标注提交成功！ID: ${result.data.unique_id}`;
                    successMsg.style.display = 'block';
                    
                    // 滚动到顶部
                    document.querySelector('.right-panel').scrollTop = 0;
                    
                    // 清空表单
                    resetForm();
                    
                    // 3秒后隐藏成功消息
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                } else {
                    alert(`提交失败: ${result.error}`);
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('提交失败，请检查网络连接并重试');
            } finally {
                hideLoading();
                submitButton.disabled = false;
                submitButton.textContent = '提交标注';
                validateForm();
            }
        }

        // 重置表单
        function resetForm() {
            // 清空主图
            mainImage = null;
            document.getElementById('mainImagePreview').innerHTML = '';
            document.getElementById('mainImageInput').value = '';
            
            // 清空参考图
            referenceImages = {
                prompt_pose: [],
                prompt_outfit: [],
                prompt_scene: [],
                prompt_composition: [],
                prompt_style: []
            };
            
            // 更新计数
            ['pose', 'outfit', 'scene', 'composition', 'style'].forEach(type => {
                updateReferenceCount(type);
            });
            
            // 清空预览
            document.getElementById('allImagesPreview').innerHTML = '';
            
            // 重置表单
            document.getElementById('annotationForm').reset();
            
            // 清空选中的标签
            document.querySelectorAll('.tag-wall').forEach(wall => {
                wall.innerHTML = '';
            });
            
            // 重置级联选择器
            document.querySelectorAll('select[disabled]').forEach(select => {
                select.innerHTML = '<option value="">请先选择上级</option>';
                select.disabled = true;
            });
            
            // 隐藏条件区域
            document.getElementById('generatedSection').style.display = 'none';
            document.getElementById('matchingSection').style.display = 'none';
            
            // 重置服装详情
            document.getElementById('outfitDetailsContainer').innerHTML = '';
            outfitCounter = 0;
            addOutfitDetail(); // 添加默认的第一个
            
            validateForm();
        }

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter 提交表单
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const submitButton = document.getElementById('submitButton');
                if (!submitButton.disabled) {
                    submitButton.click();
                }
            }
            
            // Esc 关闭加载动画
            if (e.key === 'Escape') {
                hideLoading();
            }
        });

        // 页面离开提醒
        window.addEventListener('beforeunload', function(e) {
            if (mainImage || Object.values(referenceImages).some(arr => arr.length > 0)) {
                e.preventDefault();
                e.returnValue = '您有未保存的数据，确定要离开吗？';
            }
        });

        // 错误处理
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
            hideLoading();
        });

        // Promise错误处理
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e);
            hideLoading();
        });