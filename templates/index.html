<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIBA å‚è€ƒå›¾ç‰‡æ ‡æ³¨å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .right-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            max-height: calc(100vh - 40px);
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .main-image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .form-group {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .required {
            color: #e74c3c;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .conditional-section {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .reference-upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .reference-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .reference-upload {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .reference-upload:hover {
            border-color: #007bff;
        }

        .uploaded-count {
            color: #007bff;
            font-weight: bold;
            margin-top: 5px;
        }

        .tag-wall {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-item {
            padding: 6px 12px;
            background: #e9ecef;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tag-item:hover {
            background: #dee2e6;
        }

        .tag-item.selected {
            background: #007bff;
            color: white;
        }

        .add-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .add-button:hover {
            background: #218838;
        }

        .submit-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 30px;
        }

        .submit-button:hover {
            background: #0056b3;
        }

        .submit-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #ddd;
        }

        .big-note {
            background: rgb(222, 242, 250);
            border: 1px solid #a5cafd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            margin-top:5px;
            color: #181518;
        }

        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            margin-top:5px;
            color: #856404;
        }

        .note-inside {
            margin-top:3px
        }

        .section-title {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }

        .big-section-title {
            color: #000000;
            border-bottom: 2px solid #78838f63;
            padding-bottom: 5px;
            margin-bottom: 20px;
            margin-top:20px;
            font-size: large;
        }

        .outfit-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .remove-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }

        /* æ–°å¢æ ·å¼ - å›¾ç‰‡ä¸Šä¼ ç»„åˆæ¡† */
        .image-description-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
            position: relative;
        }

        .image-description-content {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            align-items: start;
        }

        .image-preview-container {
            position: relative;
            width: 150px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-container .placeholder {
            color: #666;
            font-size: 12px;
            text-align: center;
        }

        .delete-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .image-preview-container:hover .delete-image-btn {
            display: flex;
        }

        .description-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* é”™è¯¯ä¿¡æ¯æ ·å¼ */
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .form-group.has-error .form-control,
        .form-group.has-error .upload-area {
            border-color: #dc3545;
        }

        .image-description-item.uploading {
            opacity: 0.7;
            pointer-events: none;
        }

        .upload-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .batch-upload-progress {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        @keyframes loading {
            0% { width: 0%; }
            50% { width: 100%; }
            100% { width: 0%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <h2>å›¾ç‰‡ä¸Šä¼ </h2>
            <div class="note">å®½ä¸å¾—å°‘äº1080pxï¼Œå®½é•¿æ¯”å»ºè®®ä¸º9:16ï¼ˆ1080*1920ï¼‰ï¼Œéœ€è‡³å°‘2:3ï¼ˆ1080*1620ï¼‰</div>
            <div class="upload-area" id="mainUploadArea">
                <div id="uploadContent">
                    <p>æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
                    <p style="color: #666; font-size: 12px;">
                        æ”¯æŒæ ¼å¼ï¼šPNG, JPG<br>
                        <strong>ç«–å±è¦æ±‚ï¼šé«˜åº¦å¿…é¡»å¤§äºå®½åº¦</strong><br>
                        æœ€å°åˆ†è¾¨ç‡ï¼š1080Ã—1620<br>
                        æœ€å¤§åˆ†è¾¨ç‡ï¼š2160Ã—3840
                    </p>
                </div>
                <input type="file" id="mainImageInput" accept="image/png,image/jpeg" style="display: none;">
            </div>
            <div id="mainImagePreview"></div>
        </div>

        <!-- å³ä¾§é¢æ¿ -->
        <div class="right-panel">
            <!-- åŠ è½½çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="loadingState" style="display: none;">
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 18px; color: #666; margin-bottom: 20px;">
                        ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...
                    </div>
                    <div style="width: 200px; height: 4px; background-color: #f0f0f0; border-radius: 2px; overflow: hidden; margin: 0 auto;">
                        <div style="width: 100%; height: 100%; background-color: #007bff; animation: loading 2s ease-in-out infinite;"></div>
                    </div>
                </div>
            </div>
            
            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div id="mainContent">
                <h2>æ ‡æ³¨ä¿¡æ¯</h2>
                <div class="big-note">ğŸ¥¹è¾“å…¥éƒ¨åˆ†å…¨éƒ¨ç”¨è‹±æ–‡ï¼Œæ‹œæ‰˜ä»”ç»†æ£€æŸ¥å¡«å†™ï½</div>
                <form id="annotationForm">
                    <!-- å›¾ç‰‡ä¸»é¢˜ -->
                    <div class="form-group">
                        <label class="big-section-title" for="theme">å›¾ç‰‡æ‰€å±ä¸»é¢˜</label>
                        <select class="form-control" id="theme" name="theme">
                            <option value="">æ­£åœ¨åŠ è½½ä¸»é¢˜...</option>
                        </select>
                        <div id="themeDescription" style="display: none; margin-top: 5px; font-size: 12px; color: #666;"></div>
                    </div>

                    <!-- å›¾ç‰‡ç±»å‹ -->
                    <div class="form-group">
                        <label class="big-section-title">å›¾ç‰‡ç±»å‹ <span class="required">*</span></label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="generated" name="reference_type" value="1" required>
                                <label for="generated">ç”Ÿæˆå›¾</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="matching" name="reference_type" value="2" required>
                                <label for="matching">åŒ¹é…å›¾</label>
                            </div>
                        </div>
                    </div>

                    <!-- ç”Ÿæˆå›¾æ¡ä»¶åŒºåŸŸ -->
                    <div id="generatedSection" class="conditional-section">
                        <h3 class="section-title">ç”Ÿæˆå›¾ä¿¡æ¯</h3>
                        
                        <div class="form-group">
                            <label for="contentPrompt">ç”Ÿæˆæ—¶æ‰€ç”¨çš„æç¤ºè¯ <span class="required">*</span></label>
                            <textarea class="form-control" id="contentPrompt" name="content_prompt" rows="3" placeholder="è¯·è¾“å…¥ç”Ÿæˆå›¾ç‰‡æ—¶ä½¿ç”¨çš„æç¤ºè¯"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="mlModel">ä½¿ç”¨æ¨¡å‹ <span class="required">*</span></label>
                            <input type="text" class="form-control" id="mlModel" name="ml_model_source" placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°æˆ–URL">
                        </div>

                        <!-- å§¿æ€å‚è€ƒ -->
                        <div class="form-group">
                            <label>å§¿æ€å‚è€ƒ</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="add-button" onclick="addReferenceImage('pose')">+ æ·»åŠ å§¿æ€å‚è€ƒå›¾</button>
                            </div>
                            <div id="poseImagesContainer"></div>
                        </div>

                        <!-- å•†å“å‚è€ƒ -->
                        <div class="form-group">
                            <label>å•†å“å‚è€ƒ</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="add-button" onclick="addReferenceImage('outfit')">+ æ·»åŠ å•†å“å‚è€ƒå›¾</button>
                            </div>
                            <div id="outfitImagesContainer"></div>
                        </div>

                        <!-- åœºæ™¯å‚è€ƒ -->
                        <div class="form-group">
                            <label>åœºæ™¯å‚è€ƒ</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="add-button" onclick="addReferenceImage('scene')">+ æ·»åŠ åœºæ™¯å‚è€ƒå›¾</button>
                            </div>
                            <div id="sceneImagesContainer"></div>
                        </div>

                        <!-- æ„å›¾å‚è€ƒ -->
                        <div class="form-group">
                            <label>æ„å›¾å‚è€ƒ</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="add-button" onclick="addReferenceImage('composition')">+ æ·»åŠ æ„å›¾å‚è€ƒå›¾</button>
                            </div>
                            <div id="compositionImagesContainer"></div>
                        </div>

                        <!-- é£æ ¼å‚è€ƒ -->
                        <div class="form-group">
                            <label>é£æ ¼å‚è€ƒ</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="add-button" onclick="addReferenceImage('style')">+ æ·»åŠ é£æ ¼å‚è€ƒå›¾</button>
                            </div>
                            <div id="styleImagesContainer"></div>
                        </div>
                    </div>

                    <!-- åŒ¹é…å›¾æ¡ä»¶åŒºåŸŸ -->
                    <div id="matchingSection" class="conditional-section">
                        <h3 class="section-title">åŒ¹é…å›¾ä¿¡æ¯</h3>
                        
                        <div class="form-group">
                            <label for="productIds">å•†å“ID</label>
                            <input type="text" class="form-control" id="productIds" name="product_item_ids" placeholder="è¯·è¾“å…¥å•†å“ID">
                        </div>

                        <div class="form-group">
                            <label for="poseDescription">å§¿åŠ¿æè¿°</label>
                            <textarea class="form-control" id="poseDescription" name="pose_description" rows="3" placeholder="è¯·æè¿°å›¾ç‰‡ä¸­äººç‰©çš„å§¿åŠ¿"></textarea>
                        </div>

                        <div class="form-group">
                            <label>æ˜¯å¦å¯è¢«ç”¨äºæ¢è„¸ <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="faceYes" name="can_be_used_for_face_switching" value="true">
                                    <label for="faceYes">æ˜¯</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="faceNo" name="can_be_used_for_face_switching" value="false">
                                    <label for="faceNo">å¦</label>
                                </div>
                            </div>
                            <div class="note">åˆ¤æ–­æ ‡å‡†ï¼šèƒ½å¦å±•ç¤ºå’Œé“¾æ¥åˆ°å¯¹åº”çš„å•†å“</div>
                        </div>
                    </div>

                    <!-- é£æ ¼æ ‡ç­¾ -->
                    <div class="form-group">
                        <label class="big-section-title">é£æ ¼æ ‡ç­¾ <span class="required">*</span></label>
                        <div class="note">æ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å›¾ç‰‡æ•´ä½“çš„è‰ºæœ¯é£æ ¼ï¼Œè€Œä¸æ˜¯è¡£æœçš„é£æ ¼</div>
                        <div id="styleTagsContainer">
                            <div class="tag-selection" id="styleTag0">
                                <select class="form-control" name="style_level1" style="margin-bottom: 10px;">
                                    <option value="">æ­£åœ¨åŠ è½½...</option>
                                </select>
                                <select class="form-control" name="style_level2" style="margin-bottom: 10px;" disabled>
                                    <option value="">é€‰æ‹©äºŒçº§é£æ ¼</option>
                                </select>
                                <div class="tag-wall" id="styleTagWall0"></div>
                            </div>
                        </div>
                        <button type="button" class="add-button" onclick="addStyleTag()" id="addStyleTagBtn">+ æ·»åŠ é£æ ¼æ ‡ç­¾</button>
                    </div>

                    <!-- åœºåˆæ ‡ç­¾ -->
                    <div class="form-group">
                        <label class="big-section-title">åœºåˆæ ‡ç­¾ <span class="required">*</span></label>
                        <div id="sceneTagsContainer">
                            <div class="tag-selection" id="sceneTag0">
                                <select class="form-control" name="scene_level1" style="margin-bottom: 10px;">
                                    <option value="">æ­£åœ¨åŠ è½½...</option>
                                </select>
                                <select class="form-control" name="scene_level2" style="margin-bottom: 10px;" disabled>
                                    <option value="">é€‰æ‹©äºŒçº§åœºåˆ</option>
                                </select>
                                <div class="tag-wall" id="sceneTagWall0"></div>
                            </div>
                        </div>
                        <button type="button" class="add-button" onclick="addSceneTag()" id="addSceneTagBtn">+ æ·»åŠ åœºåˆæ ‡ç­¾</button>
                    </div>

                    <!-- æ¨¡ç‰¹æ•°æ®æ ‡ç­¾ -->
                    <div class="form-group">
                        <label class="big-section-title">æ¨¡ç‰¹æ•°æ®æ ‡ç­¾ <span class="required">*</span></label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px;">
                            <div>
                                <label>å¹´é¾„</label>
                                <select class="form-control" name="age" required>
                                    <option value="">æ­£åœ¨åŠ è½½...</option>
                                </select>
                            </div>
                            <div>
                                <label>æ€§åˆ«</label>
                                <select class="form-control" name="gender" required>
                                    <option value="">æ­£åœ¨åŠ è½½...</option>
                                </select>
                            </div>
                            <div>
                                <label>ç§æ—</label>
                                <select class="form-control" name="race" required>
                                    <option value="">æ­£åœ¨åŠ è½½...</option>
                                </select>
                            </div>
                            <div>
                                <label>ä½“å‹</label>
                                <select class="form-control" name="size" required>
                                    <option value="">æ­£åœ¨åŠ è½½...</option>
                                </select>
                            </div>
                        </div>
                        <div class="note">
                                <p><a style="font-weight: bold">ğŸ’ƒNotes:</a></p>
                                <p class = "note-inside"><a style="font-weight: bold">Petite:</a> Heights under 5'4" (163cm), with proportions scaled for a smaller frame.</p>
                                <p class = "note-inside"><a style="font-weight: bold">Standard:</a> Industry's standard size range (e.g., US 0-12).</p>
                                <p class = "note-inside"><a style="font-weight: bold">Curve:</a> "Plus Size". For fuller-figured body types (e.g., US 14+).</p>
                                <p class = "note-inside"><a style="font-weight: bold">Tall:</a> Heights over 5'9" (175cm), with longer limb and torso proportions.</p>
                                <p class = "note-inside"><a style="font-weight: bold">Maternity:</a> Specifically designed to accommodate a pregnant figure, with features like an expanding belly.</p>
                        </div>
                    </div>

                    <!-- å§¿æ€æ ‡ç­¾ -->
                    <div class="form-group">
                        <label class="big-section-title" for="poseTag">å§¿æ€æ ‡ç­¾</label>
                        <select class="form-control" id="poseTag" name="pose_tag_ids">
                            <option value="">æ­£åœ¨åŠ è½½...</option>
                        </select>
                    </div>

                    <!-- æ„å›¾æ ‡æ³¨ -->
                    <div class="form-group">
                        <label class="big-section-title">æ„å›¾æ ‡æ³¨</label>
                        <div class="note">ğŸ“¸<a style="font-weight: bold;">Note:</a> è§’åº¦å¦‚æœæ¯”è¾ƒæ™®é€šã€æ˜¯"å¹³è§†"ç±»å‹å°±ä¸ç”¨å¡«å†™ï½é‡ç‚¹åœ¨äºæ‰“ä¸Šå›¾ç‰‡ç‰¹ç‚¹æ ‡ç­¾</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px;">
                            <div>
                                <label>é•œå¤´ç±»å‹</label>
                                <select class="form-control" name="camera_type">
                                    <option value="">é€‰æ‹©é•œå¤´ç±»å‹</option>
                                    <option value="close_up">ç‰¹å†™</option>
                                    <option value="medium_shot">ä¸­æ™¯</option>
                                    <option value="long_shot">è¿œæ™¯</option>
                                    <option value="extreme_wide_shot">å¤§è¿œæ™¯</option>
                                </select>
                            </div>
                            <div>
                                <label>é•œå¤´è§’åº¦</label>
                                <select class="form-control" name="camera_angle">
                                    <option value="">é€‰æ‹©é•œå¤´è§’åº¦</option>
                                    <option value="high_angle">ä¿¯è§’</option>
                                    <option value="low_angle">ä»°è§’</option>
                                    <option value="wide_angle">å¹¿è§’</option>
                                    <option value="fisheye">é±¼çœ¼</option>
                                </select>
                            </div>
                            <div>
                                <label>äººèº«æ¯”ä¾‹</label>
                                <select class="form-control" name="body_ratio">
                                    <option value="">é€‰æ‹©äººèº«æ¯”ä¾‹</option>
                                    <option value="head_shot">å¤´éƒ¨ç‰¹å†™</option>
                                    <option value="head_shoulders">å¤´è‚©æ¯”ä¾‹</option>
                                    <option value="bust_shot">åŠèº«åƒ</option>
                                    <option value="three_quarter">å››åˆ†ä¹‹ä¸‰èº«</option>
                                    <option value="full_body">å…¨èº«åƒ</option>
                                    <option value="multiple_people">å¤šäººæ„å›¾</option>
                                </select>
                            </div>
                            <div>
                                <label>äººç‰©ä½ç½®</label>
                                <select class="form-control" name="character_position">
                                    <option value="">é€‰æ‹©äººç‰©ä½ç½®</option>
                                    <option value="center">å±…ä¸­</option>
                                    <option value="left">å·¦ä¾§</option>
                                    <option value="right">å³ä¾§</option>
                                    <option value="top">åä¸Š</option>
                                    <option value="bottom">åä¸‹</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- æœè£…æ ‡æ³¨ -->
                    <div class="form-group">
                        <label class="big-section-title">æœè£…æ ‡æ³¨</label>
                        <div id="outfitDetailsContainer">
                        </div>
                        <button type="button" class="add-button" onclick="addOutfitDetail()" id="addOutfitBtn">+ æ·»åŠ æœè£…æ ‡æ³¨</button>
                    </div>

                    <button type="submit" class="submit-button" id="submitButton">æäº¤æ ‡æ³¨</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let mainImage = null;
        let referenceImages = {
            pose: [],
            outfit: [],
            scene: [],
            composition: [],
            style: []
        };
        let outfitCounter = 1;
        let styleTagCounter = 1;
        let sceneTagCounter = 1;
        let referenceImageCounters = {
            pose: 0,
            outfit: 0,
            scene: 0,
            composition: 0,
            style: 0
        };

        // è·å–çœŸå®æ•°æ®
        let tagData = {
            multi_level: {},    // å¤šçº§æ ‡ç­¾ï¼ˆé£æ ¼ã€åœºåˆç­‰ï¼‰
            single_level: {},   // å•çº§æ ‡ç­¾ï¼ˆå¹´é¾„ã€æ€§åˆ«ç­‰ï¼‰
            loaded: false
        };

        async function loadThemesFromAPI() {
            try {
                const response = await fetch('/api/themes', {
                    method: 'GET'
                });
                const result = await response.json();
                
                if (result.success) {
                    const themeSelect = document.getElementById('theme');
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼Œä¿ç•™é»˜è®¤é€‰é¡¹
                    themeSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸»é¢˜</option>';
                    
                    // æ·»åŠ ä»APIè·å–çš„ä¸»é¢˜
                    result.data.forEach(theme => {
                        const option = document.createElement('option');
                        option.value = theme.unique_id;  // ä½¿ç”¨çœŸå®çš„ä¸»é¢˜ID
                        option.textContent = theme.title;  // æ˜¾ç¤ºä¸»é¢˜æ ‡é¢˜
                        option.title = theme.description || '';  // å¯é€‰ï¼šæ·»åŠ æè¿°ä½œä¸ºtooltip
                        themeSelect.appendChild(option);
                    });
                    
                    return true;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Failed to load themes:', error);
                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨fallbacké€‰é¡¹
                const themeSelect = document.getElementById('theme');
                themeSelect.innerHTML = '<option value="">é€‰æ‹©ä¸»é¢˜ (æ•°æ®åŠ è½½å¤±è´¥)</option>';
                return false;
            }
        }

        async function loadTagsFromAPI() {
            try {
                const response = await fetch('/api/tags/all');
                const result = await response.json();
                
                if (result.success) {
                    tagData = {
                        ...result.data,
                        loaded: true
                    };
            
                    // åˆå§‹åŒ–æ ‡ç­¾é€‰æ‹©å™¨
                    initializeTagSelectors();
                    return true;
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Failed to load tags:', error);
                // ä¸å†å¼¹å‡ºalertï¼Œè€Œæ˜¯ä½¿ç”¨fallbackæ•°æ®
                initializeFallbackTagSelectors();
                return false;
            }
        }

        // åˆå§‹åŒ–æ ‡ç­¾é€‰æ‹©å™¨
        function initializeTagSelectors() {
            if (!tagData.loaded) {
                console.warn('Tag data not loaded, cannot initialize selectors');
                return;
            }

            // åˆå§‹åŒ–é£æ ¼æ ‡ç­¾
            initializeStyleSelectors();
            
            // åˆå§‹åŒ–åœºåˆæ ‡ç­¾  
            initializeSceneSelectors();
            
            // åˆå§‹åŒ–æ¨¡ç‰¹å±æ€§æ ‡ç­¾
            initializeModelAttributeSelectors();
            
            // åˆå§‹åŒ–å§¿æ€æ ‡ç­¾
            initializePoseTagSelector();
            
            // å¯ç”¨æŒ‰é’®
            document.getElementById('addStyleTagBtn').disabled = false;
            document.getElementById('addSceneTagBtn').disabled = false;
            document.getElementById('addOutfitBtn').disabled = false;
        }

        // åˆå§‹åŒ–é£æ ¼æ ‡ç­¾é€‰æ‹©å™¨
        function initializeStyleSelectors() {
            const styleLevel1Select = document.querySelector('#styleTag0 select[name="style_level1"]');
            if (styleLevel1Select && tagData.multi_level.style && tagData.multi_level.style.cascade.level1) {
                styleLevel1Select.innerHTML = '<option value="">é€‰æ‹©ä¸€çº§é£æ ¼</option>';
                tagData.multi_level.style.cascade.level1.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    styleLevel1Select.appendChild(option);
                });
            }
        }

        // åˆå§‹åŒ–åœºåˆæ ‡ç­¾é€‰æ‹©å™¨
        function initializeSceneSelectors() {
            const sceneLevel1Select = document.querySelector('#sceneTag0 select[name="scene_level1"]');
            if (sceneLevel1Select && tagData.multi_level.scene && tagData.multi_level.scene.cascade.level1) {
                sceneLevel1Select.innerHTML = '<option value="">é€‰æ‹©ä¸€çº§åœºåˆ</option>';
                tagData.multi_level.scene.cascade.level1.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    sceneLevel1Select.appendChild(option);
                });
            }
        }

        // åˆå§‹åŒ–æ¨¡ç‰¹å±æ€§æ ‡ç­¾é€‰æ‹©å™¨
        function initializeModelAttributeSelectors() {
            const attributeSelectors = [
                { name: 'age', selector: 'select[name="age"]' },
                { name: 'gender', selector: 'select[name="gender"]' },
                { name: 'race', selector: 'select[name="race"]' },
                { name: 'size', selector: 'select[name="size"]' }
            ];

            attributeSelectors.forEach(({ name, selector }) => {
                const selectElement = document.querySelector(selector);
                if (selectElement && tagData.single_level[name] && tagData.single_level[name].list) {
                    selectElement.innerHTML = `<option value="">é€‰æ‹©${name === 'age' ? 'å¹´é¾„' : name === 'gender' ? 'æ€§åˆ«' : name === 'race' ? 'ç§æ—' : 'ä½“å‹'}</option>`;
                    tagData.single_level[name].list.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag.id;
                        option.textContent = tag.name_cn || tag.name;
                        selectElement.appendChild(option);
                    });
                }
            });
        }

        // åˆå§‹åŒ–å§¿æ€æ ‡ç­¾é€‰æ‹©å™¨
        function initializePoseTagSelector() {
            const poseTagSelect = document.getElementById('poseTag');
            if (poseTagSelect && tagData.single_level.pose && tagData.single_level.pose.list) {
                poseTagSelect.innerHTML = '<option value="">é€‰æ‹©å§¿æ€æ ‡ç­¾</option>';
                tagData.single_level.pose.list.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name_cn || tag.name;
                    poseTagSelect.appendChild(option);
                });
            }
        }

        // Fallbackåˆå§‹åŒ–å‡½æ•°ï¼ˆå½“APIåŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
        function initializeFallbackTagSelectors() {
            // ä½¿ç”¨ç¡¬ç¼–ç çš„fallbackæ•°æ®
            const fallbackData = {
                style: ['å†™å®', 'è‰ºæœ¯', 'å¡é€š'],
                scene: ['æ—¥å¸¸', 'å·¥ä½œ', 'èšä¼š', 'æˆ·å¤–'],
                age: ['Teenager (14-17)', 'Young Adult (18-20)', 'Middle Aged (31-60)','Senior (61-80)'],
                gender: ['Male', 'Female'],
                race: ['East Asian', 'South Asian', 'White', 'Black', 'Latino'],
                size: ['Petite', 'Standard', 'Curve','Tall','Maternity']
            };

            // é£æ ¼æ ‡ç­¾fallback
            const styleLevel1Select = document.querySelector('#styleTag0 select[name="style_level1"]');
            if (styleLevel1Select) {
                styleLevel1Select.innerHTML = '<option value="">é€‰æ‹©ä¸€çº§é£æ ¼</option>';
                fallbackData.style.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `style_${index}`;
                    option.textContent = label;
                    styleLevel1Select.appendChild(option);
                });
            }

            // åœºåˆæ ‡ç­¾fallback
            const sceneLevel1Select = document.querySelector('#sceneTag0 select[name="scene_level1"]');
            if (sceneLevel1Select) {
                sceneLevel1Select.innerHTML = '<option value="">é€‰æ‹©ä¸€çº§åœºåˆ</option>';
                fallbackData.scene.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `scene_${index}`;
                    option.textContent = label;
                    sceneLevel1Select.appendChild(option);
                });
            }

            // æ¨¡ç‰¹å±æ€§fallback
            ['age', 'gender', 'race', 'size'].forEach(attr => {
                const select = document.querySelector(`select[name="${attr}"]`);
                if (select && fallbackData[attr]) {
                    const labels = { age: 'å¹´é¾„', gender: 'æ€§åˆ«', race: 'ç§æ—', size: 'ä½“å‹' };
                    select.innerHTML = `<option value="">é€‰æ‹©${labels[attr]}</option>`;
                    fallbackData[attr].forEach((label, index) => {
                        const option = document.createElement('option');
                        option.value = `${attr}_${index}`;
                        option.textContent = label;
                        select.appendChild(option);
                    });
                }
            });

            // å§¿æ€æ ‡ç­¾fallback
            const poseTagSelect = document.getElementById('poseTag');
            if (poseTagSelect) {
                poseTagSelect.innerHTML = '<option value="">é€‰æ‹©å§¿æ€æ ‡ç­¾ (æ•°æ®åŠ è½½å¤±è´¥)</option>';
            }

            // å¯ç”¨æŒ‰é’®
            document.getElementById('addStyleTagBtn').disabled = false;
            document.getElementById('addSceneTagBtn').disabled = false;
            document.getElementById('addOutfitBtn').disabled = false;

            console.warn('Using fallback tag data due to API failure');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoadingState();
            
            // å¹¶è¡ŒåŠ è½½ä¸»é¢˜å’Œæ ‡ç­¾æ•°æ®
            const [themesLoaded, tagsLoaded] = await Promise.all([
                loadThemesFromAPI(),
                loadTagsFromAPI()
            ]);
            
            // æ— è®ºåŠ è½½æ˜¯å¦æˆåŠŸéƒ½ç»§ç»­åˆå§‹åŒ–
            initializeEventListeners();
            loadFromLocalStorage();
            validateForm();
            hideLoadingState();
            
            if (!themesLoaded) {
                console.warn('Themes failed to load, using fallback');
            }
            if (!tagsLoaded) {
                console.warn('Tags failed to load, using fallback');
            }
        });

        function initializeEventListeners() {
            // ä¸»å›¾ä¸Šä¼ 
            const mainUploadArea = document.getElementById('mainUploadArea');
            const mainImageInput = document.getElementById('mainImageInput');

            mainUploadArea.addEventListener('click', () => mainImageInput.click());
            mainUploadArea.addEventListener('dragover', handleDragOver);
            mainUploadArea.addEventListener('drop', handleMainImageDrop);
            mainImageInput.addEventListener('change', handleMainImageSelect);

            // å›¾ç‰‡ç±»å‹åˆ‡æ¢
            document.querySelectorAll('input[name="reference_type"]').forEach(radio => {
                radio.addEventListener('change', handleReferenceTypeChange);
            });

            // æœè£…ç±»åˆ«çº§è”
            document.addEventListener('change', function(e) {
                // äº§å“ç±»å‹çº§è”
                if (e.target.name === 'product_type_level1') {
                    updateOutfitLevel2(e.target);
                } else if (e.target.name === 'product_type_level2') {
                    updateOutfitLevel3(e.target);
                }
            });

            // é£æ ¼å’Œåœºåˆæ ‡ç­¾çº§è”
            document.addEventListener('change', function(e) {
                if (e.target.name === 'style_level1') {
                    updateStyleLevel2(e.target);
                } else if (e.target.name === 'style_level2') {
                    updateStyleTagWall(e.target);
                } else if (e.target.name === 'scene_level1') {
                    updateSceneLevel2(e.target);
                } else if (e.target.name === 'scene_level2') {
                    updateSceneTagWall(e.target);
                }
            });

            // è¡¨å•æäº¤
            document.getElementById('annotationForm').addEventListener('submit', handleSubmit);

            // è¡¨å•å˜åŒ–ç›‘å¬
            document.addEventListener('input', saveToLocalStorage);
            document.addEventListener('change', saveToLocalStorage);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleMainImageDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleMainImageFile(files[0]);
            }
        }

        function handleMainImageSelect(e) {
            if (e.target.files.length > 0) {
                handleMainImageFile(e.target.files[0]);
            }
        }

        async function handleMainImageFile(file) {
            if (!file.type.match('image/(png|jpeg)')) {
                alert('è¯·ä¸Šä¼ PNGæˆ–JPGæ ¼å¼çš„å›¾ç‰‡');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    if (img.width < 1080 || img.height < 1620) {
                        alert('å›¾ç‰‡åˆ†è¾¨ç‡å¿…é¡»è‡³å°‘ä¸º1080Ã—1620');
                        return;
                    }
                    if (img.width > 2160 || img.height > 3840) {
                        alert('å›¾ç‰‡åˆ†è¾¨ç‡ä¸èƒ½è¶…è¿‡2160Ã—3840');
                        return;
                    }
                    if (img.height <= img.width) {
                        alert('å›¾ç‰‡å¿…é¡»æ˜¯ç«–å±ï¼ˆé«˜åº¦å¤§äºå®½åº¦ï¼‰');
                        return;
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const uploadArea = document.getElementById('mainUploadArea');
            const originalContent = uploadArea.innerHTML;
            uploadArea.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 16px; color: #007bff; margin-bottom: 10px;">
                        ğŸ“¤ æ­£åœ¨ä¸Šä¼ ä¸»å›¾...
                    </div>
                    <div style="width: 100%; background-color: #f0f0f0; border-radius: 10px; overflow: hidden;">
                        <div id="mainUploadProgress" style="width: 0%; height: 8px; background-color: #007bff; transition: width 0.3s;"></div>
                    </div>
                </div>
            `;

            try {
                // åˆ›å»ºFormDataå¯¹è±¡
                const formData = new FormData();
                formData.append('file', file);
                formData.append('image_type', 'main_image');

                // è°ƒç”¨ä¸Šä¼ API
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // ä¸Šä¼ æˆåŠŸ
                    mainImage = {
                        file: file,
                        url: URL.createObjectURL(file), // æœ¬åœ°é¢„è§ˆç”¨
                        s3_url: result.data.url,        // çœŸå®çš„S3 URL
                        cached: result.data.cached,     // æ˜¯å¦æ¥è‡ªç¼“å­˜
                        image_info: result.data.image_info
                    };

                    displayMainImage();
                    saveToLocalStorage();
                    validateForm();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (result.data.cached) {
                        console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ (æ¥è‡ªç¼“å­˜)');
                    } else {
                        console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('ä¸»å›¾ä¸Šä¼ å¤±è´¥:', error);
                alert(`ä¸»å›¾ä¸Šä¼ å¤±è´¥: ${error.message}`);
                
                // æ¢å¤åŸå§‹ä¸Šä¼ åŒºåŸŸ
                uploadArea.innerHTML = originalContent;
            }
        }

        function displayMainImage() {
            const preview = document.getElementById('mainImagePreview');
            preview.innerHTML = `
                <div style="position: relative; display: inline-block;">
                    <img src="${mainImage.url}" class="main-image-preview" alt="ä¸»å›¾é¢„è§ˆ">
                    <button class="delete-image-btn" onclick="deleteMainImage()" style="display: flex;">Ã—</button>
                </div>
            `;
        }

        function deleteMainImage() {
            mainImage = null;
            document.getElementById('mainImagePreview').innerHTML = '';
            document.getElementById('mainImageInput').value = '';
            saveToLocalStorage();
            validateForm();
        }

        function addReferenceImage(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/jpeg';
            input.onchange = (e) => {
                if (e.target.files.length > 0) {
                    handleReferenceImageFile(e.target.files[0], type);
                }
            };
            input.click();
        }

        async function handleReferenceImageFile(file, type) {
            if (!file.type.match('image/(png|jpeg)')) {
                alert(`${file.name}: è¯·ä¸Šä¼ PNGæˆ–JPGæ ¼å¼çš„å›¾ç‰‡`);
                return;
            }

            const imageId = `${type}_${referenceImageCounters[type]++}`;
            
            // å…ˆåˆ›å»ºå ä½ç¬¦æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
            const imageData = {
                id: imageId,
                file: file,
                url: URL.createObjectURL(file),  // ä¸´æ—¶é¢„è§ˆ
                s3_url: null,  // ä¸Šä¼ å®Œæˆåæ›´æ–°
                description: '',
                uploading: true
            };

            referenceImages[type].push(imageData);
            createImageDescriptionItem(type, imageData);

            try {
                // åˆ›å»ºFormDataå¯¹è±¡
                const formData = new FormData();
                formData.append('file', file);
                formData.append('image_type', `${type}_reference`);

                // è°ƒç”¨ä¸Šä¼ API
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // æ›´æ–°å›¾ç‰‡æ•°æ®
                    imageData.s3_url = result.data.url;
                    imageData.cached = result.data.cached;
                    imageData.image_info = result.data.image_info;
                    imageData.uploading = false;

                    // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                    updateImageDescriptionItem(type, imageData);
                    
                    saveToLocalStorage();
                    validateForm();

                    console.log(`âœ… ${type}å‚è€ƒå›¾ä¸Šä¼ æˆåŠŸ`, result.data.cached ? '(æ¥è‡ªç¼“å­˜)' : '');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error(`${type}å‚è€ƒå›¾ä¸Šä¼ å¤±è´¥:`, error);
                
                // ç§»é™¤å¤±è´¥çš„å›¾ç‰‡
                deleteReferenceImage(type, imageId);
                
                alert(`${type}å‚è€ƒå›¾ä¸Šä¼ å¤±è´¥: ${error.message}`);
            }
        }

        function createImageDescriptionItem(type, imageData) {
            const container = document.getElementById(`${type}ImagesContainer`);
            const div = document.createElement('div');
            div.className = 'image-description-item';
            div.id = imageData.id;
            
            const uploadingClass = imageData.uploading ? 'uploading' : '';
            const uploadingText = imageData.uploading ? '(ä¸Šä¼ ä¸­...)' : '';
            
            div.innerHTML = `
                <div class="image-description-content ${uploadingClass}">
                    <div class="image-preview-container">
                        <img src="${imageData.url}" alt="${type}å‚è€ƒå›¾">
                        <button class="delete-image-btn" onclick="deleteReferenceImage('${type}', '${imageData.id}')" 
                                ${imageData.uploading ? 'style="display: none;"' : ''}>Ã—</button>
                        ${imageData.uploading ? '<div class="upload-spinner">â³</div>' : ''}
                    </div>
                    <div class="description-input-container">
                        <label>å›¾ç‰‡æè¿° (é€‰å¡«) ${uploadingText}</label>
                        <textarea class="form-control" placeholder="è¯·æè¿°è¿™å¼ å›¾ç‰‡ï¼Œå¯å¤åˆ¶Promptä¸­ç›¸å…³å†…å®¹..." rows="3" 
                                onchange="updateImageDescription('${type}', '${imageData.id}', this.value)"
                                ${imageData.uploading ? 'disabled' : ''}></textarea>
                        ${imageData.s3_url ? `<small style="color: #28a745; font-size: 11px;">âœ… ä¸Šä¼ å®Œæˆ</small>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(div);
        }

        function updateImageDescriptionItem(type, imageData) {
            const element = document.getElementById(imageData.id);
            if (element) {
                const content = element.querySelector('.image-description-content');
                content.classList.remove('uploading');
                
                const deleteBtn = element.querySelector('.delete-image-btn');
                if (deleteBtn) deleteBtn.style.display = 'flex';
                
                const spinner = element.querySelector('.upload-spinner');
                if (spinner) spinner.remove();
                
                const textarea = element.querySelector('textarea');
                if (textarea) textarea.disabled = false;
                
                const label = element.querySelector('label');
                if (label) label.textContent = 'å›¾ç‰‡æè¿° (é€‰å¡«)';
                
                // æ·»åŠ ä¸Šä¼ å®Œæˆæç¤º
                const container = element.querySelector('.description-input-container');
                if (container && !container.querySelector('small')) {
                    const successText = document.createElement('small');
                    successText.style.color = '#28a745';
                    successText.style.fontSize = '11px';
                    successText.textContent = 'âœ… ä¸Šä¼ å®Œæˆ';
                    container.appendChild(successText);
                }
            }
        }

        function deleteReferenceImage(type, imageId) {
            // ä»æ•°ç»„ä¸­ç§»é™¤
            const index = referenceImages[type].findIndex(img => img.id === imageId);
            if (index > -1) {
                referenceImages[type].splice(index, 1);
            }
            
            // ä»DOMä¸­ç§»é™¤
            const element = document.getElementById(imageId);
            if (element) {
                element.remove();
            }
            
            saveToLocalStorage();
            validateForm();
        }

        function updateImageDescription(type, imageId, value) {
            const imageData = referenceImages[type].find(img => img.id === imageId);
            if (imageData) {
                imageData.description = value;
                saveToLocalStorage();
            }
        }

        function handleReferenceTypeChange(e) {
            const isGenerated = e.target.value === '1';
            document.getElementById('generatedSection').style.display = isGenerated ? 'block' : 'none';
            document.getElementById('matchingSection').style.display = isGenerated ? 'none' : 'block';
            validateForm();
        }

        function updateOutfitLevel2(select) {
            const container = select.closest('.outfit-item');
            const level2Select = container.querySelector('select[name="product_type_level2"]');
            const level3Select = container.querySelector('select[name="product_type_level3"]');
            
            // é‡ç½®ä¸‹çº§é€‰æ‹©å™¨
            level2Select.innerHTML = '<option value="">é€‰æ‹©äºŒçº§ç±»åˆ«</option>';
            level3Select.innerHTML = '<option value="">é€‰æ‹©ä¸‰çº§ç±»åˆ«</option>';
            level3Select.disabled = true;
            
            const selectedLevel1Id = select.value;
            if (!selectedLevel1Id || !tagData.loaded) {
                level2Select.disabled = true;
                return;
            }
            
            // ä»çœŸå®æ ‡ç­¾æ•°æ®è·å–äºŒçº§é€‰é¡¹
            const productTypeData = tagData.multi_level.product_type;
            if (productTypeData && productTypeData.cascade.level2_by_parent[selectedLevel1Id]) {
                level2Select.disabled = false;
                
                productTypeData.cascade.level2_by_parent[selectedLevel1Id].forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    level2Select.appendChild(option);
                });
            } else {
                level2Select.disabled = true;
            }
        }

        function updateOutfitLevel3(select) {
            const container = select.closest('.outfit-item');
            const level3Select = container.querySelector('select[name="product_type_level3"]');
            
            level3Select.innerHTML = '<option value="">é€‰æ‹©ä¸‰çº§ç±»åˆ«</option>';
            
            const selectedLevel2Id = select.value;
            if (!selectedLevel2Id || !tagData.loaded) {
                level3Select.disabled = true;
                return;
            }
            
            // ä»çœŸå®æ ‡ç­¾æ•°æ®è·å–ä¸‰çº§é€‰é¡¹
            const productTypeData = tagData.multi_level.product_type;
            if (productTypeData && productTypeData.cascade.level3_by_parent[selectedLevel2Id]) {
                level3Select.disabled = false;
                
                productTypeData.cascade.level3_by_parent[selectedLevel2Id].forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    level3Select.appendChild(option);
                });
            } else {
                level3Select.disabled = true;
            }
        }
        
        function updateStyleLevel2(select) {
            const container = select.parentNode;
            const level2Select = container.querySelector('select[name="style_level2"]');
            const tagWall = container.querySelector('.tag-wall');
            
            level2Select.innerHTML = '<option value="">é€‰æ‹©äºŒçº§é£æ ¼</option>';
            tagWall.innerHTML = '';
            
            const selectedLevel1Id = select.value;
            if (!selectedLevel1Id) {
                level2Select.disabled = true;
                return;
            }
            
            // å¦‚æœæ²¡æœ‰åŠ è½½çœŸå®æ•°æ®ï¼Œä½¿ç”¨fallbacké€»è¾‘
            if (!tagData.loaded) {
                level2Select.disabled = false;
                level2Select.innerHTML = '<option value="">é€‰æ‹©äºŒçº§é£æ ¼</option><option value="fallback_style2">é€šç”¨é£æ ¼</option>';
                return;
            }
            
            // ä»çœŸå®æ ‡ç­¾æ•°æ®è·å–å­çº§æ ‡ç­¾
            const styleTagData = tagData.multi_level.style;
            if (styleTagData && styleTagData.cascade.level2_by_parent[selectedLevel1Id]) {
                level2Select.disabled = false;
                
                styleTagData.cascade.level2_by_parent[selectedLevel1Id].forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;  // çœŸå®çš„æ ‡ç­¾ID
                    option.textContent = tag.label;  // ä¸­æ–‡æ˜¾ç¤ºå
                    level2Select.appendChild(option);
                });
            } else {
                level2Select.disabled = true;
            }
        }

        function updateStyleTagWall(select) {
            const container = select.parentNode;
            const level1Select = container.querySelector('select[name="style_level1"]');
            const tagWall = container.querySelector('.tag-wall');
            
            tagWall.innerHTML = '';
            
            const selectedLevel2Id = select.value;
            const selectedLevel1Id = level1Select.value;
            
            if (!selectedLevel2Id) return;
            
            // å¦‚æœæ²¡æœ‰åŠ è½½çœŸå®æ•°æ®ï¼Œä½¿ç”¨fallbacké€»è¾‘
            if (!tagData.loaded) {
                const fallbackTags = ['æ ‡ç­¾A', 'æ ‡ç­¾B', 'æ ‡ç­¾C'];
                fallbackTags.forEach((label, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'tag-item';
                    button.textContent = label;
                    button.dataset.tagId = `fallback_scene_${index}`;
                    button.onclick = () => toggleTag(button);
                    tagWall.appendChild(button);
                });
                return;
            }

            // è·å–ç¬¬ä¸‰çº§æ ‡ç­¾ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰
            const styleTagData = tagData.multi_level.style;
            if (styleTagData && styleTagData.cascade.level3_by_parent[selectedLevel2Id]) {
                styleTagData.cascade.level3_by_parent[selectedLevel2Id].forEach(tag => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'tag-item';
                    button.textContent = tag.label;  // æ˜¾ç¤ºä¸­æ–‡å
                    button.dataset.tagId = tag.value;  // å­˜å‚¨çœŸå®ID
                    button.onclick = () => toggleTag(button);
                    tagWall.appendChild(button);
                });
            }
        }

        function updateSceneLevel2(select) {
            const container = select.parentNode;
            const level2Select = container.querySelector('select[name="scene_level2"]');
            const tagWall = container.querySelector('.tag-wall');
            
            level2Select.innerHTML = '<option value="">é€‰æ‹©äºŒçº§åœºåˆ</option>';
            tagWall.innerHTML = '';
            
            const selectedLevel1Id = select.value;
            if (!selectedLevel1Id) {
                level2Select.disabled = true;
                return;
            }
            
            // å¦‚æœæ²¡æœ‰åŠ è½½çœŸå®æ•°æ®ï¼Œä½¿ç”¨fallbacké€»è¾‘
            if (!tagData.loaded) {
                level2Select.disabled = false;
                level2Select.innerHTML = '<option value="">é€‰æ‹©äºŒçº§åœºåˆ</option><option value="fallback_scene2">é€šç”¨åœºåˆ</option>';
                return;
            }
            
            // ä»çœŸå®æ ‡ç­¾æ•°æ®è·å–å­çº§æ ‡ç­¾
            const sceneTagData = tagData.multi_level.scene;
            if (sceneTagData && sceneTagData.cascade.level2_by_parent[selectedLevel1Id]) {
                level2Select.disabled = false;
                
                sceneTagData.cascade.level2_by_parent[selectedLevel1Id].forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;  // çœŸå®çš„æ ‡ç­¾ID
                    option.textContent = tag.label;  // ä¸­æ–‡æ˜¾ç¤ºå
                    level2Select.appendChild(option);
                });
            } else {
                level2Select.disabled = true;
            }
        }

        function updateSceneTagWall(select) {
            const container = select.parentNode;
            const level1Select = container.querySelector('select[name="scene_level1"]');
            const tagWall = container.querySelector('.tag-wall');
            
            tagWall.innerHTML = '';
            
            const selectedLevel2Id = select.value;
            const selectedLevel1Id = level1Select.value;
            
            if (!selectedLevel2Id) return;
            
            // è·å–ç¬¬ä¸‰çº§æ ‡ç­¾ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰
            const sceneTagData = tagData.multi_level.scene;
            if (sceneTagData && sceneTagData.cascade.level3_by_parent[selectedLevel2Id]) {
                sceneTagData.cascade.level3_by_parent[selectedLevel2Id].forEach(tag => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'tag-item';
                    button.textContent = tag.label;  // æ˜¾ç¤ºä¸­æ–‡å
                    button.dataset.tagId = tag.value;  // å­˜å‚¨çœŸå®ID
                    button.onclick = () => toggleTag(button);
                    tagWall.appendChild(button);
                });
            }
        }
    

        function toggleTag(button) {
            button.classList.toggle('selected');
            saveToLocalStorage();
            validateForm();
        }

        function addStyleTag() {
            const container = document.getElementById('styleTagsContainer');
            const newTag = document.createElement('div');
            newTag.className = 'tag-selection';
            newTag.id = `styleTag${styleTagCounter}`;
            newTag.innerHTML = `
                <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <button type="button" class="remove-button" onclick="removeStyleTag(${styleTagCounter})" style="margin-bottom: 10px;">åˆ é™¤æ­¤é¡¹</button>
                    <select class="form-control" name="style_level1" style="margin-bottom: 10px;">
                        <option value="">é€‰æ‹©ä¸€çº§é£æ ¼</option>
                    </select>
                    <select class="form-control" name="style_level2" style="margin-bottom: 10px;" disabled>
                        <option value="">é€‰æ‹©äºŒçº§é£æ ¼</option>
                    </select>
                    <div class="tag-wall" id="styleTagWall${styleTagCounter}"></div>
                </div>
            `;
            container.appendChild(newTag);
            
            // å¡«å……æ–°æ·»åŠ çš„é£æ ¼é€‰æ‹©å™¨
            const newStyleLevel1 = newTag.querySelector('select[name="style_level1"]');
            if (tagData.loaded && tagData.multi_level.style && tagData.multi_level.style.cascade.level1) {
                tagData.multi_level.style.cascade.level1.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    newStyleLevel1.appendChild(option);
                });
            } else {
                // Fallbackæ•°æ®
                const fallbackStyles = ['å†™å®', 'è‰ºæœ¯', 'å¡é€š'];
                fallbackStyles.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `style_${index}`;
                    option.textContent = label;
                    newStyleLevel1.appendChild(option);
                });
            }
            
            styleTagCounter++;
        }

        function removeStyleTag(id) {
            const element = document.getElementById(`styleTag${id}`);
            if (element) {
                element.remove();
                saveToLocalStorage();
                validateForm();
            }
        }

        function addSceneTag() {
            const container = document.getElementById('sceneTagsContainer');
            const newTag = document.createElement('div');
            newTag.className = 'tag-selection';
            newTag.id = `sceneTag${sceneTagCounter}`;
            newTag.innerHTML = `
                <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                    <button type="button" class="remove-button" onclick="removeSceneTag(${sceneTagCounter})" style="margin-bottom: 10px;">åˆ é™¤æ­¤é¡¹</button>
                    <select class="form-control" name="scene_level1" style="margin-bottom: 10px;">
                        <option value="">é€‰æ‹©ä¸€çº§åœºåˆ</option>
                    </select>
                    <select class="form-control" name="scene_level2" style="margin-bottom: 10px;" disabled>
                        <option value="">é€‰æ‹©äºŒçº§åœºåˆ</option>
                    </select>
                    <div class="tag-wall" id="sceneTagWall${sceneTagCounter}"></div>
                </div>
            `;
            container.appendChild(newTag);
            
            // å¡«å……æ–°æ·»åŠ çš„åœºåˆé€‰æ‹©å™¨
            const newSceneLevel1 = newTag.querySelector('select[name="scene_level1"]');
            if (tagData.loaded && tagData.multi_level.scene && tagData.multi_level.scene.cascade.level1) {
                tagData.multi_level.scene.cascade.level1.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    newSceneLevel1.appendChild(option);
                });
            } else {
                // Fallbackæ•°æ®
                const fallbackScenes = ['æ—¥å¸¸', 'å·¥ä½œ', 'èšä¼š', 'æˆ·å¤–'];
                fallbackScenes.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `scene_${index}`;
                    option.textContent = label;
                    newSceneLevel1.appendChild(option);
                });
            }
            
            sceneTagCounter++;
        }

        function removeSceneTag(id) {
            const element = document.getElementById(`sceneTag${id}`);
            if (element) {
                element.remove();
                saveToLocalStorage();
                validateForm();
            }
        }

        function addOutfitDetail() {
            const container = document.getElementById('outfitDetailsContainer');
            const newOutfit = document.createElement('div');
            newOutfit.className = 'outfit-item';
            newOutfit.id = `outfit${outfitCounter}`;
            
            newOutfit.innerHTML = `
                <button type="button" class="remove-button" onclick="removeOutfit(${outfitCounter})">åˆ é™¤</button>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>æœé¥°ç±»åˆ«</label>
                        <select class="form-control outfit-type" name="product_type_level1">
                            <option value="">é€‰æ‹©ä¸€çº§ç±»åˆ«</option>
                        </select>
                        <select class="form-control" name="product_type_level2" style="margin-top: 10px;" disabled>
                            <option value="">é€‰æ‹©äºŒçº§ç±»åˆ«</option>
                        </select>
                        <select class="form-control" name="product_type_level3" style="margin-top: 10px;" disabled>
                            <option value="">é€‰æ‹©ä¸‰çº§ç±»åˆ«</option>
                        </select>
                    </div>
                    <div>
                        <label>æœé¥°æè´¨ (Main)</label>
                        <select class="form-control" name="fabric_tag_ids">
                            <option value="">é€‰æ‹©æè´¨</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label>æœé¥°ç‰ˆå‹</label>
                        <select class="form-control" name="silhouette_tag_ids">
                            <option value="">é€‰æ‹©ç‰ˆå‹</option>
                        </select>
                    </div>
                    <div>
                        <label>é¢œè‰²æ ‡ç­¾</label>
                        <select class="form-control" name="color_tag_ids">
                            <option value="">é€‰æ‹©é¢œè‰²</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(newOutfit);
            
            // å¡«å……çœŸå®æ•°æ®æˆ–fallbackæ•°æ®
            populateOutfitSelectors(newOutfit);
            
            outfitCounter++;
            saveToLocalStorage();
            validateForm();
        }

        function populateOutfitSelectors(outfitElement) {
            // å¡«å……äº§å“ç±»å‹ï¼ˆå¤šçº§æ ‡ç­¾ï¼‰
            const productTypeLevel1 = outfitElement.querySelector('select[name="product_type_level1"]');
            if (tagData.loaded && tagData.multi_level.product_type && tagData.multi_level.product_type.cascade.level1) {
                tagData.multi_level.product_type.cascade.level1.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;  // çœŸå®æ ‡ç­¾ID
                    option.textContent = tag.label;  // ä¸­æ–‡æ˜¾ç¤ºå
                    productTypeLevel1.appendChild(option);
                });
            } else {
                // Fallbackæ•°æ®
                const fallbackProductTypes = ['ä¸Šè£…', 'ä¸‹è£…', 'é‹ç±»', 'é…ä»¶'];
                fallbackProductTypes.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `product_${index}`;
                    option.textContent = label;
                    productTypeLevel1.appendChild(option);
                });
            }

            // å¡«å……é¢æ–™æ ‡ç­¾ï¼ˆå•çº§æ ‡ç­¾ï¼‰
            const fabricSelect = outfitElement.querySelector('select[name="fabric_tag_ids"]');
            if (tagData.loaded && tagData.single_level.fabric && tagData.single_level.fabric.list) {
                tagData.single_level.fabric.list.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name_cn || tag.name;
                    fabricSelect.appendChild(option);
                });
            } else {
                // Fallbackæ•°æ®
                const fallbackFabrics = ['æ£‰', 'ä¸ç»¸', 'æ¯›æ–™', 'èšé…¯çº¤ç»´'];
                fallbackFabrics.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `fabric_${index}`;
                    option.textContent = label;
                    fabricSelect.appendChild(option);
                });
            }

            // å¡«å……å»“å½¢æ ‡ç­¾ï¼ˆå¤šçº§æ ‡ç­¾ï¼‰
            const silhouetteSelect = outfitElement.querySelector('select[name="silhouette_tag_ids"]');
            if (tagData.loaded && tagData.multi_level.silhouette && tagData.multi_level.silhouette.cascade.level1) {
                tagData.multi_level.silhouette.cascade.level1.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.value;
                    option.textContent = tag.label;
                    silhouetteSelect.appendChild(option);
                });
            } else {
                // Fallbackæ•°æ®
                const fallbackSilhouettes = ['ä¿®èº«', 'å®½æ¾', 'ç›´ç­’', 'ç´§èº«'];
                fallbackSilhouettes.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `silhouette_${index}`;
                    option.textContent = label;
                    silhouetteSelect.appendChild(option);
                });
            }

            // å¡«å……é¢œè‰²æ ‡ç­¾ï¼ˆå•çº§æ ‡ç­¾ï¼‰
            const colorSelect = outfitElement.querySelector('select[name="color_tag_ids"]');
            if (tagData.loaded && tagData.single_level.color && tagData.single_level.color.list) {
                tagData.single_level.color.list.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name_cn || tag.name;
                    colorSelect.appendChild(option);
                });
            } else {
                // Fallbackæ•°æ®
                const fallbackColors = ['é»‘è‰²', 'ç™½è‰²', 'çº¢è‰²', 'è“è‰²', 'ç°è‰²'];
                fallbackColors.forEach((label, index) => {
                    const option = document.createElement('option');
                    option.value = `color_${index}`;
                    option.textContent = label;
                    colorSelect.appendChild(option);
                });
            }
        }

        function removeOutfit(id) {
            const element = document.getElementById(`outfit${id}`);
            if (element) {
                element.remove();
                saveToLocalStorage();
                validateForm();
            }
        }

        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        function hideLoadingState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function validateFormForSubmit() {
            // æ¸…é™¤æ‰€æœ‰é”™è¯¯ä¿¡æ¯
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });

            let isValid = true;
            let firstErrorElement = null;

            // æ£€æŸ¥ä¸»å›¾
            if (!mainImage) {
                const uploadArea = document.getElementById('mainUploadArea');
                showError(uploadArea, 'è¯·ä¸Šä¼ ä¸»å›¾');
                if (!firstErrorElement) firstErrorElement = uploadArea;
                isValid = false;
            }
            // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ­£åœ¨ä¸Šä¼ 
            const hasUploadingImages = Object.values(referenceImages).some(images => 
                images.some(img => img.uploading || !img.s3_url)
            );

            if (hasUploadingImages) {
                alert('å›¾ç‰‡ä»åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç­‰å¾…ä¸Šä¼ å®Œæˆåå†æäº¤');
                return false;
            }

            // æ£€æŸ¥ä¸»å›¾æ˜¯å¦æœ‰S3 URL
            if (mainImage && !mainImage.s3_url) {
                alert('ä¸»å›¾ä¸Šä¼ æœªå®Œæˆï¼Œè¯·ç­‰å¾…ä¸Šä¼ å®Œæˆåå†æäº¤');
                return false;
            }

            // æ£€æŸ¥å›¾ç‰‡ç±»å‹
            const referenceType = document.querySelector('input[name="reference_type"]:checked');
            if (!referenceType) {
                const radioGroup = document.querySelector('input[name="reference_type"]').closest('.form-group');
                showError(radioGroup, 'è¯·é€‰æ‹©å›¾ç‰‡ç±»å‹');
                if (!firstErrorElement) firstErrorElement = radioGroup;
                isValid = false;
            } else {
                // æ£€æŸ¥å¯¹åº”çš„å¿…å¡«å­—æ®µ
                if (referenceType.value === '1') {
                    // ç”Ÿæˆå›¾å¿…å¡«å­—æ®µ
                    const prompt = document.getElementById('contentPrompt').value.trim();
                    const model = document.getElementById('mlModel').value.trim();
                    if (!prompt) {
                        showError(document.getElementById('contentPrompt'), 'è¯·è¾“å…¥ç”Ÿæˆæ—¶æ‰€ç”¨çš„æç¤ºè¯');
                        if (!firstErrorElement) firstErrorElement = document.getElementById('contentPrompt');
                        isValid = false;
                    }
                    if (!model) {
                        showError(document.getElementById('mlModel'), 'è¯·è¾“å…¥ä½¿ç”¨æ¨¡å‹');
                        if (!firstErrorElement) firstErrorElement = document.getElementById('mlModel');
                        isValid = false;
                    }
                } else {
                    // åŒ¹é…å›¾å¿…å¡«å­—æ®µ
                    const faceSwitch = document.querySelector('input[name="can_be_used_for_face_switching"]:checked');
                    if (!faceSwitch) {
                        const faceSwitchGroup = document.querySelector('input[name="can_be_used_for_face_switching"]').closest('.form-group');
                        showError(faceSwitchGroup, 'è¯·é€‰æ‹©æ˜¯å¦å¯è¢«ç”¨äºæ¢è„¸');
                        if (!firstErrorElement) firstErrorElement = faceSwitchGroup;
                        isValid = false;
                    }
                }
            }

            // æ£€æŸ¥é£æ ¼æ ‡ç­¾
            const styleSelections = document.querySelectorAll('#styleTagsContainer .tag-selection');
            let hasStyleTag = false;
            styleSelections.forEach(selection => {
                const selectedTags = selection.querySelectorAll('.tag-item.selected');
                if (selectedTags.length > 0) {
                    hasStyleTag = true;
                }
            });
            if (!hasStyleTag) {
                const styleContainer = document.getElementById('styleTagsContainer').closest('.form-group');
                showError(styleContainer, 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé£æ ¼æ ‡ç­¾');
                if (!firstErrorElement) firstErrorElement = styleContainer;
                isValid = false;
            }

            // æ£€æŸ¥åœºåˆæ ‡ç­¾
            const sceneSelections = document.querySelectorAll('#sceneTagsContainer .tag-selection');
            let hasSceneTag = false;
            sceneSelections.forEach(selection => {
                const selectedTags = selection.querySelectorAll('.tag-item.selected');
                if (selectedTags.length > 0) {
                    hasSceneTag = true;
                }
            });
            if (!hasSceneTag) {
                const sceneContainer = document.getElementById('sceneTagsContainer').closest('.form-group');
                showError(sceneContainer, 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœºåˆæ ‡ç­¾');
                if (!firstErrorElement) firstErrorElement = sceneContainer;
                isValid = false;
            }

            // æ£€æŸ¥æ¨¡ç‰¹æ•°æ®
            const modelFields = [
                { element: document.querySelector('select[name="age"]'), name: 'å¹´é¾„' },
                { element: document.querySelector('select[name="gender"]'), name: 'æ€§åˆ«' },
                { element: document.querySelector('select[name="race"]'), name: 'ç§æ—' },
                { element: document.querySelector('select[name="size"]'), name: 'ä½“å‹' }
            ];

            modelFields.forEach(field => {
                if (!field.element.value) {
                    showError(field.element, `è¯·é€‰æ‹©${field.name}`);
                    if (!firstErrorElement) firstErrorElement = field.element;
                    isValid = false;
                }
            });

            // å¦‚æœæœ‰é”™è¯¯ï¼Œæ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯ä½ç½®
            if (!isValid && firstErrorElement) {
                firstErrorElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                // æ·»åŠ é«˜äº®æ•ˆæœ
                firstErrorElement.style.transition = 'box-shadow 0.3s ease';
                firstErrorElement.style.boxShadow = '0 0 0 3px rgba(255, 71, 87, 0.3)';
                setTimeout(() => {
                    firstErrorElement.style.boxShadow = '';
                }, 2000);
            }

            return isValid;
        }

        function showError(element, message) {
            let errorElement = element.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('error-message')) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                element.parentNode.insertBefore(errorElement, element.nextSibling);
            }
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        function validateForm() {
            // ä¿æŒåŸæœ‰çš„å®æ—¶éªŒè¯é€»è¾‘ï¼Œä½†ä¸ç¦ç”¨æŒ‰é’®
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸»è¦ç”¨äºå®æ—¶æ£€æŸ¥ï¼Œä¸å½±å“æŒ‰é’®çŠ¶æ€
            const submitButton = document.getElementById('submitButton');
            let isValid = true;

            // æ£€æŸ¥ä¸»å›¾
            if (!mainImage) {
                isValid = false;
            }

            // æ£€æŸ¥å›¾ç‰‡ç±»å‹
            const referenceType = document.querySelector('input[name="reference_type"]:checked');
            if (!referenceType) {
                isValid = false;
            } else {
                // æ£€æŸ¥å¯¹åº”çš„å¿…å¡«å­—æ®µ
                if (referenceType.value === '1') {
                    // ç”Ÿæˆå›¾å¿…å¡«å­—æ®µ
                    const prompt = document.getElementById('contentPrompt').value.trim();
                    const model = document.getElementById('mlModel').value.trim();
                    if (!prompt || !model) {
                        isValid = false;
                    }
                } else {
                    // åŒ¹é…å›¾å¿…å¡«å­—æ®µ
                    const faceSwitch = document.querySelector('input[name="can_be_used_for_face_switching"]:checked');
                    if (!faceSwitch) {
                        isValid = false;
                    }
                }
            }

            // æ£€æŸ¥é£æ ¼æ ‡ç­¾
            const styleSelections = document.querySelectorAll('#styleTagsContainer .tag-selection');
            let hasStyleTag = false;
            styleSelections.forEach(selection => {
                const selectedTags = selection.querySelectorAll('.tag-item.selected');
                if (selectedTags.length > 0) {
                    hasStyleTag = true;
                }
            });
            if (!hasStyleTag) {
                isValid = false;
            }
        }

        function saveToLocalStorage() {
            const formData = {
                mainImage: mainImage,
                referenceImages: referenceImages,
                formValues: {}
            };

            // ä¿å­˜è¡¨å•æ•°æ®
            const form = document.getElementById('annotationForm');
            const formElements = form.querySelectorAll('input, select, textarea');
            formElements.forEach(element => {
                if (element.type === 'radio' || element.type === 'checkbox') {
                    formData.formValues[element.name + '_' + element.value] = element.checked;
                } else {
                    formData.formValues[element.name] = element.value;
                }
            });

            // ä¿å­˜é€‰ä¸­çš„æ ‡ç­¾
            const selectedTags = document.querySelectorAll('.tag-item.selected');
            formData.selectedTags = Array.from(selectedTags).map(tag => ({
                parent: tag.parentNode.id,
                text: tag.textContent,
                tagId: tag.dataset.tagId
            }));

            localStorage.setItem('imageAnnotationData', JSON.stringify(formData));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('imageAnnotationData');
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                
                // æ¢å¤ä¸»å›¾
                if (data.mainImage) {
                    mainImage = data.mainImage;
                    displayMainImage();
                }

                // æ¢å¤å‚è€ƒå›¾
                if (data.referenceImages) {
                    referenceImages = data.referenceImages;
                    Object.keys(referenceImages).forEach(type => {
                        referenceImages[type].forEach((imageData) => {
                            createImageDescriptionItem(type, imageData);
                        });
                    });
                }

                // æ¢å¤è¡¨å•æ•°æ®
                if (data.formValues) {
                    Object.keys(data.formValues).forEach(key => {
                        if (key.includes('_')) {
                            const [name, value] = key.split('_');
                            const element = document.querySelector(`input[name="${name}"][value="${value}"]`);
                            if (element) {
                                element.checked = data.formValues[key];
                                if (element.checked && element.type === 'radio') {
                                    element.dispatchEvent(new Event('change'));
                                }
                            }
                        } else {
                            const element = document.querySelector(`[name="${key}"]`);
                            if (element) {
                                element.value = data.formValues[key];
                                if (element.tagName === 'SELECT') {
                                    element.dispatchEvent(new Event('change'));
                                }
                            }
                        }
                    });
                }

                // æ¢å¤é€‰ä¸­çš„æ ‡ç­¾
                if (data.selectedTags) {
                    setTimeout(() => {
                        data.selectedTags.forEach(tagData => {
                            const parent = document.getElementById(tagData.parent);
                            if (parent) {
                                const tag = Array.from(parent.querySelectorAll('.tag-item'))
                                    .find(t => t.textContent === tagData.text || t.dataset.tagId === tagData.tagId);
                                if (tag) {
                                    tag.classList.add('selected');
                                }
                            }
                        });
                        validateForm();
                    }, 100);
                }

            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
        }

        function clearLocalStorage() {
            localStorage.removeItem('imageAnnotationData');
        }

        function collectFormData() {
            const formData = {
                // åŸºç¡€ä¿¡æ¯
                reference_image_url: mainImage ? mainImage.s3_url : null,
                reference_type: parseInt(document.querySelector('input[name="reference_type"]:checked')?.value || '0'),
            };

            // ä¸»é¢˜ä¿¡æ¯ï¼ˆå¦‚æœé€‰æ‹©äº†ä¸»é¢˜ï¼‰
            const themeValue = document.getElementById('theme').value;
            if (themeValue) {
                formData.theme_ids = [themeValue];
            }

            // æ ¹æ®å›¾ç‰‡ç±»å‹æ·»åŠ å¯¹åº”å­—æ®µ
            if (formData.reference_type === 1) {
                // ç”Ÿæˆå›¾å­—æ®µ
                formData.gen_content_prompt = document.getElementById('contentPrompt').value.trim();
                formData.gen_ml_model_source = document.getElementById('mlModel').value.trim();
                
                // æ”¶é›†å„ç±»å‚è€ƒå›¾å’Œæè¿°
                const referenceTypes = ['pose', 'outfit', 'scene', 'composition', 'style'];
                referenceTypes.forEach(type => {
                    const images = referenceImages[type] || [];
                    if (images.length > 0) {
                        formData[`gen_${type}_images`] = images.map(img => img.s3_url).filter(url => url);
                        formData[`gen_${type}_description`] = images.map(img => img.description || '');
                    }
                });
                
            } else if (formData.reference_type === 2) {
                // åŒ¹é…å›¾å­—æ®µ
                const productIds = document.getElementById('productIds').value.trim();
                if (productIds) {
                    formData.product_item_ids = productIds.split(',').map(id => id.trim()).filter(id => id);
                }
                
                const poseDesc = document.getElementById('poseDescription').value.trim();
                if (poseDesc) {
                    formData.pose_description = poseDesc;
                }
                
                const faceSwitch = document.querySelector('input[name="can_be_used_for_face_switching"]:checked');
                if (faceSwitch) {
                    formData.can_be_used_for_face_switching = faceSwitch.value === 'true';
                }
            }

            // æ”¶é›†é£æ ¼æ ‡ç­¾ID
            formData.style_tag_ids = collectSelectedTagIds('#styleTagsContainer');
            
            // æ”¶é›†åœºåˆæ ‡ç­¾ID  
            formData.scene_tag_ids = collectSelectedTagIds('#sceneTagsContainer');

            // æ”¶é›†æ¨¡ç‰¹å±æ€§æ ‡ç­¾ID
            formData.model_attribute_tag_ids = collectModelAttributeTagIds();

            // æ”¶é›†å§¿æ€æ ‡ç­¾ID
            const poseTagValue = document.getElementById('poseTag').value;
            if (poseTagValue) {
                formData.pose_tag_ids = [parseInt(poseTagValue)];
            }

            // æ”¶é›†æ„å›¾æ ‡æ³¨ä¿¡æ¯
            formData.composition_annotation = collectCompositionAnnotation();

            // æ”¶é›†æœè£…è¯¦æƒ…
            formData.outfit_details = collectOutfitDetails();

            return formData;
        }

        // æ”¶é›†é€‰ä¸­çš„æ ‡ç­¾ID
        function collectSelectedTagIds(containerSelector) {
            const tagIds = [];
            document.querySelectorAll(`${containerSelector} .tag-selection`).forEach(selection => {
                const selectedTags = Array.from(selection.querySelectorAll('.tag-item.selected'))
                    .map(tag => {
                        const tagId = tag.dataset.tagId;
                        // å¤„ç†æ•°å­—IDå’Œfallback ID
                        return isNaN(tagId) ? tagId : parseInt(tagId);
                    })
                    .filter(id => id !== undefined && id !== null);
                tagIds.push(...selectedTags);
            });
            return [...new Set(tagIds)]; // å»é‡
        }

        // æ”¶é›†æ¨¡ç‰¹å±æ€§æ ‡ç­¾ID
        function collectModelAttributeTagIds() {
            const attributes = [];
            const attributeSelectors = [
                'select[name="age"]',
                'select[name="gender"]', 
                'select[name="race"]',
                'select[name="size"]'
            ];
            
            attributeSelectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (element && element.value) {
                    const value = element.value;
                    // å¤„ç†æ•°å­—IDå’Œfallback ID
                    attributes.push(isNaN(value) ? value : parseInt(value));
                }
            });
            
            return attributes;
        }

        // æ”¶é›†æ„å›¾æ ‡æ³¨ä¿¡æ¯
        function collectCompositionAnnotation() {
            const annotation = {};
            const compositionFields = [
                'camera_type',
                'camera_angle', 
                'body_ratio',
                'character_position'
            ];
            
            compositionFields.forEach(field => {
                const element = document.querySelector(`select[name="${field}"]`);
                if (element && element.value) {
                    annotation[field] = element.value;
                }
            });
            
            return Object.keys(annotation).length > 0 ? annotation : null;
        }

        // æ”¶é›†æœè£…è¯¦æƒ…
        function collectOutfitDetails() {
            const outfitDetails = [];
            
            document.querySelectorAll('.outfit-item').forEach(item => {
                const outfit = {};
                
                // äº§å“ç±»å‹æ ‡ç­¾ï¼ˆå¤šçº§ï¼‰
                const level1Value = item.querySelector('select[name="product_type_level1"]').value;
                const level2Value = item.querySelector('select[name="product_type_level2"]').value;
                const level3Value = item.querySelector('select[name="product_type_level3"]').value;
                
                if (level1Value) {
                    const productType = {
                        level1: isNaN(level1Value) ? level1Value : parseInt(level1Value),
                        level2: level2Value ? (isNaN(level2Value) ? level2Value : parseInt(level2Value)) : null,
                        level3: level3Value ? (isNaN(level3Value) ? level3Value : parseInt(level3Value)) : null
                    };
                    outfit.product_type_tag_ids = productType;
                }
                
                // å•çº§æ ‡ç­¾
                const singleTags = [
                    { name: 'fabric_tag_ids', selector: 'select[name="fabric_tag_ids"]' },
                    { name: 'silhouette_tag_ids', selector: 'select[name="silhouette_tag_ids"]' },
                    { name: 'color_tag_ids', selector: 'select[name="color_tag_ids"]' }
                ];
                
                singleTags.forEach(tag => {
                    const element = item.querySelector(tag.selector);
                    if (element && element.value) {
                        const value = element.value;
                        outfit[tag.name] = isNaN(value) ? value : parseInt(value);
                    }
                });
                
                // åªæ·»åŠ æœ‰å®é™…é€‰æ‹©çš„outfité¡¹
                if (Object.keys(outfit).length > 0) {
                    outfitDetails.push(outfit);
                }
            });
            
            return outfitDetails;
        }

        async function handleSubmit(e) {
            e.preventDefault();
            
            // é¦–å…ˆè¿›è¡Œè¡¨å•éªŒè¯
            if (!validateFormForSubmit()) {
                return;
            }
            
            const submitButton = document.getElementById('submitButton');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'æ­£åœ¨æäº¤...';

            try {
                // æ”¶é›†è¡¨å•æ•°æ®
                const formData = collectFormData();
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                const validationError = validateSubmissionData(formData);
                if (validationError) {
                    throw new Error(validationError);
                }

                // è°ƒç”¨åˆ›å»ºå‚è€ƒå›¾API
                const response = await fetch('/api/reference-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    // æäº¤æˆåŠŸ
                    showSuccessMessage(result.data);
                    
                    // é‡ç½®è¡¨å•
                    await resetFormAfterSuccess();
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    clearLocalStorage();
                    
                } else {
                    throw new Error(result.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showErrorMessage(error.message);
                
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                validateForm();
            }
        }

        function validateSubmissionData(formData) {
            // æ£€æŸ¥ä¸»å›¾URL
            if (!formData.reference_image_url) {
                return 'è¯·ä¸Šä¼ ä¸»å›¾';
            }
            
            // æ£€æŸ¥å›¾ç‰‡ç±»å‹
            if (!formData.reference_type || (formData.reference_type !== 1 && formData.reference_type !== 2)) {
                return 'è¯·é€‰æ‹©å›¾ç‰‡ç±»å‹';
            }
            
            // æ ¹æ®ç±»å‹æ£€æŸ¥ç‰¹å®šå­—æ®µ
            if (formData.reference_type === 1) {
                if (!formData.gen_content_prompt) {
                    return 'ç”Ÿæˆå›¾å¿…é¡»å¡«å†™æç¤ºè¯';
                }
                if (!formData.gen_ml_model_source) {
                    return 'ç”Ÿæˆå›¾å¿…é¡»å¡«å†™ä½¿ç”¨æ¨¡å‹';
                }
            } else if (formData.reference_type === 2) {
                if (formData.can_be_used_for_face_switching === undefined) {
                    return 'åŒ¹é…å›¾å¿…é¡»é€‰æ‹©æ˜¯å¦å¯ç”¨äºæ¢è„¸';
                }
            }
            
            // æ£€æŸ¥é£æ ¼æ ‡ç­¾
            if (!formData.style_tag_ids || formData.style_tag_ids.length === 0) {
                return 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé£æ ¼æ ‡ç­¾';
            }
    
            // æ£€æŸ¥åœºåˆæ ‡ç­¾
            if (!formData.scene_tag_ids || formData.scene_tag_ids.length === 0) {
                return 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåœºåˆæ ‡ç­¾';
            }
            
            // æ£€æŸ¥æ¨¡ç‰¹å±æ€§æ ‡ç­¾
            if (!formData.model_attribute_tag_ids || formData.model_attribute_tag_ids.length === 0) {
                return 'è¯·å®Œæ•´å¡«å†™æ¨¡ç‰¹æ•°æ®æ ‡ç­¾';
            }
            
            return null; // éªŒè¯é€šè¿‡
        }

        async function resetFormAfterSuccess() {
            // é‡ç½®è¡¨å•
            document.getElementById('annotationForm').reset();
            
            // æ¸…ç©ºä¸»å›¾
            mainImage = null;
            document.getElementById('mainImagePreview').innerHTML = '';
            document.getElementById('mainImageInput').value = '';
            
            // æ¸…ç©ºå‚è€ƒå›¾
            referenceImages = {
                pose: [],
                outfit: [],
                scene: [],
                composition: [],
                style: []
            };
            
            // æ¸…ç©ºå‚è€ƒå›¾å®¹å™¨
            Object.keys(referenceImages).forEach(type => {
                document.getElementById(`${type}ImagesContainer`).innerHTML = '';
            });
            
            // é‡ç½®è®¡æ•°å™¨
            referenceImageCounters = {
                pose: 0,
                outfit: 0,
                scene: 0,
                composition: 0,
                style: 0    
            };
            
            // é‡ç½®æ¡ä»¶åŒºåŸŸ
            document.getElementById('generatedSection').style.display = 'none';
            document.getElementById('matchingSection').style.display = 'none';
            
            // æ¢å¤æ ‡ç­¾å®¹å™¨åˆå§‹çŠ¶æ€
            await resetTagContainers();
            
            // æ¸…ç©ºæœè£…æ ‡æ³¨å®¹å™¨
            document.getElementById('outfitDetailsContainer').innerHTML = '';
            
            // é‡ç½®è®¡æ•°å™¨
            outfitCounter = 1;
            styleTagCounter = 1;
            sceneTagCounter = 1;
            
            // æ¸…é™¤æ‰€æœ‰é”™è¯¯ä¿¡æ¯
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });
        }

        async function resetTagContainers() {
            // æ¢å¤é£æ ¼æ ‡ç­¾å®¹å™¨åˆå§‹çŠ¶æ€
            const styleContainer = document.getElementById('styleTagsContainer');
            styleContainer.innerHTML = `
                <div class="tag-selection" id="styleTag0">
                    <select class="form-control" name="style_level1" style="margin-bottom: 10px;">
                        <option value="">é€‰æ‹©ä¸€çº§é£æ ¼</option>
                    </select>
                    <select class="form-control" name="style_level2" style="margin-bottom: 10px;" disabled>
                        <option value="">é€‰æ‹©äºŒçº§é£æ ¼</option>
                    </select>
                    <div class="tag-wall" id="styleTagWall0"></div>
                </div>
            `;
            
            // æ¢å¤åœºåˆæ ‡ç­¾å®¹å™¨åˆå§‹çŠ¶æ€
            const sceneContainer = document.getElementById('sceneTagsContainer');
            sceneContainer.innerHTML = `
                <div class="tag-selection" id="sceneTag0">
                    <select class="form-control" name="scene_level1" style="margin-bottom: 10px;">
                        <option value="">é€‰æ‹©ä¸€çº§åœºåˆ</option>
                    </select>
                    <select class="form-control" name="scene_level2" style="margin-bottom: 10px;" disabled>
                        <option value="">é€‰æ‹©äºŒçº§åœºåˆ</option>
                    </select>
                    <div class="tag-wall" id="sceneTagWall0"></div>
                </div>
            `;
            
            // é‡æ–°å¡«å……æ ‡ç­¾æ•°æ®
            initializeTagSelectors();
        }

        function showSuccessMessage(responseData) {
            // åˆ›å»ºæˆåŠŸæç¤ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">âœ…</div>
                    <h3 style="color: #28a745; margin-bottom: 15px;">æäº¤æˆåŠŸï¼</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        æ ‡æ³¨æ•°æ®å·²æˆåŠŸä¿å­˜<br>
                        è®°å½•ID: ${responseData.unique_id || 'æœªçŸ¥'}
                    </p>
                    <button onclick="this.closest('div').parentNode.remove()" 
                            style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        ç¡®å®š
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 3000);
        }

        function showErrorMessage(errorMessage) {
            // åˆ›å»ºé”™è¯¯æç¤ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 500px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                    <h3 style="color: #dc3545; margin-bottom: 15px;">æäº¤å¤±è´¥</h3>
                    <p style="color: #666; margin-bottom: 20px; word-break: break-word;">
                        ${errorMessage}
                    </p>
                    <button onclick="this.closest('div').parentNode.remove()" 
                            style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                        ç¡®å®š
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>