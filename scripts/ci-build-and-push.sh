#!/bin/bash

# VIBA Image Annotation Tool - CI Build and Push Script
# ç”¨äºŽåœ¨ Mac ä¸Šä½¿ç”¨ Colima/Buildx æž„å»º Linux é•œåƒå¹¶æŽ¨é€åˆ° ECR

set -e

# é…ç½®
AWS_REGION="us-west-2"
ECR_REGISTRY="686255979277.dkr.ecr.us-west-2.amazonaws.com"
BACKEND_REPO="internal/annot-image-backend"
FRONTEND_REPO="internal/annot-image-frontend"
PLATFORM="linux/amd64"  # AWS EKS ä½¿ç”¨çš„å¹³å°

# èŽ·å–å½“å‰æ—¶é—´æˆ³ä½œä¸ºæ ‡ç­¾
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
TAG="${TIMESTAMP}-${GIT_COMMIT}"

echo "ðŸš€ Building VIBA Image Annotation Tool images for ${PLATFORM}..."
echo "ðŸ“¦ Tag: ${TAG}"

# ç¡®ä¿ä½¿ç”¨ colima docker contextï¼ˆå¦‚æžœå¯ç”¨ï¼‰
if docker context ls | grep -q "colima"; then
    echo "ðŸ”§ Using colima Docker context..."
    docker context use colima
fi

# æ£€æŸ¥ Docker buildx æ˜¯å¦å¯ç”¨
if ! docker buildx version >/dev/null 2>&1; then
    echo "âŒ Docker buildx is not available. Please install Docker Desktop or enable buildx."
    echo "ðŸ’¡ Run: ./scripts/setup-buildx.sh"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰åˆé€‚çš„ builder
if ! docker buildx ls | grep -q "multiarch"; then
    echo "ðŸ”§ Creating multiarch builder..."
    docker buildx create --name multiarch --driver docker-container --bootstrap --use
else
    echo "âœ… Using existing multiarch builder"
    docker buildx use multiarch
fi

# ç™»å½•åˆ° ECR
echo "ðŸ” Logging in to ECR..."
aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REGISTRY}

# ç¡®ä¿ ECR ä»“åº“å­˜åœ¨
echo "ðŸ—ï¸  Ensuring ECR repositories exist..."
aws ecr describe-repositories --repository-names ${BACKEND_REPO} --region ${AWS_REGION} >/dev/null 2>&1 || {
    echo "   Creating backend repository..."
    aws ecr create-repository --repository-name ${BACKEND_REPO} --region ${AWS_REGION}
}

aws ecr describe-repositories --repository-names ${FRONTEND_REPO} --region ${AWS_REGION} >/dev/null 2>&1 || {
    echo "   Creating frontend repository..."
    aws ecr create-repository --repository-name ${FRONTEND_REPO} --region ${AWS_REGION}
}

# æž„å»ºå¹¶æŽ¨é€åŽç«¯é•œåƒ
echo "ðŸ”¨ Building and pushing backend image..."
docker buildx build \
    --platform ${PLATFORM} \
    --file Dockerfile.backend \
    --tag ${ECR_REGISTRY}/${BACKEND_REPO}:${TAG} \
    --tag ${ECR_REGISTRY}/${BACKEND_REPO}:latest \
    --push \
    .

# æž„å»ºå¹¶æŽ¨é€å‰ç«¯é•œåƒ
echo "ðŸ”¨ Building and pushing frontend image..."
docker buildx build \
    --platform ${PLATFORM} \
    --file Dockerfile.frontend \
    --tag ${ECR_REGISTRY}/${FRONTEND_REPO}:${TAG} \
    --tag ${ECR_REGISTRY}/${FRONTEND_REPO}:latest \
    --push \
    .

echo "âœ… Build and push completed successfully!"
echo "ðŸ“‹ Image Details:"
echo "   Backend: ${ECR_REGISTRY}/${BACKEND_REPO}:${TAG}"
echo "   Frontend: ${ECR_REGISTRY}/${FRONTEND_REPO}:${TAG}"

# ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
echo "ðŸ“ Generating deployment info..."
cat > ./deployment-info.env << EOF
# Generated by CI build on $(date)
BACKEND_IMAGE=${ECR_REGISTRY}/${BACKEND_REPO}:${TAG}
FRONTEND_IMAGE=${ECR_REGISTRY}/${FRONTEND_REPO}:${TAG}
BUILD_TAG=${TAG}
BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
GIT_COMMIT=${GIT_COMMIT}
EOF

echo "âœ… Deployment info saved to deployment-info.env"
echo ""
echo "ðŸš€ Ready for deployment! Run:"
echo "   ./scripts/cd-deploy.sh"
